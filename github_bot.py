# github_bot.py - Telegram –±–æ—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤
import os
import requests
import random
import json
import time
import logging
import re
import sys
import argparse
import threading
import base64
import hashlib
from datetime import datetime, timedelta
from urllib.parse import quote_plus
from typing import Dict, List, Optional, Tuple, Any, Union
import telebot
from telebot.types import Message, ReactionTypeEmoji, InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery

# ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
logger = logging.getLogger(__name__)

BOT_TOKEN = os.environ.get("BOT_TOKEN")
MAIN_CHANNEL = os.environ.get("MAIN_CHANNEL_ID", "@da4a_hr")
ZEN_CHANNEL = os.environ.get("ZEN_CHANNEL_ID", "@tehdzenm")
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")
PEXELS_API_KEY = os.environ.get("PEXELS_API_KEY")
ADMIN_CHAT_ID = os.environ.get("ADMIN_CHAT_ID")
GITHUB_TOKEN = os.environ.get("MANAGER_GITHUB_TOKEN")
REPO_NAME = os.environ.get("REPO_NAME", "")
REPO_OWNER = os.environ.get("GITHUB_REPOSITORY_OWNER", "")

CRITICAL_VARS = {
    "BOT_TOKEN": BOT_TOKEN,
    "GEMINI_API_KEY": GEMINI_API_KEY,
    "ADMIN_CHAT_ID": ADMIN_CHAT_ID
}

for var_name, var_value in CRITICAL_VARS.items():
    if not var_value:
        logger.error(f"‚ùå {var_name} –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–µ–Ω!")
        sys.exit(1)

if not PEXELS_API_KEY:
    logger.warning("‚ö†Ô∏è PEXELS_API_KEY –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–µ–Ω! –ë—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏")

logger.info("üì§ –†–µ–∂–∏–º: –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–æ–≤ –≤ –ª–∏—á–Ω—ã–π —á–∞—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")

session = requests.Session()
session.headers.update({
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
    'Accept': 'application/json, text/plain, */*',
    'Content-Type': 'application/json'
})
session.timeout = 30


# ========== –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ö–õ–ê–°–°–´ ==========
class PostStatus:
    PENDING = "pending"
    APPROVED = "approved"
    NEEDS_EDIT = "needs_edit"
    PUBLISHED = "published"
    REJECTED = "rejected"


class GitHubAPIManager:
    BASE_URL = "https://api.github.com"
    
    def __init__(self):
        self.github_token = GITHUB_TOKEN
        self.repo_owner = REPO_OWNER
        self.repo_name = REPO_NAME
    
    def _get_headers(self) -> Dict:
        headers = {"Accept": "application/vnd.github.v3+json"}
        if self.github_token:
            headers["Authorization"] = f"token {self.github_token}"
        return headers
    
    def get_file_content(self, file_path: str) -> Union[Dict, str]:
        try:
            if not self.github_token or not self.repo_owner or not self.repo_name:
                return {"error": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é"}
            
            url = f"{self.BASE_URL}/repos/{self.repo_owner}/{self.repo_name}/contents/{file_path}"
            response = session.get(url, headers=self._get_headers())
            
            if response.status_code == 200:
                content = response.json()
                if "content" in content and content.get("encoding") == "base64":
                    decoded = base64.b64decode(content["content"]).decode('utf-8')
                    return decoded
                return {"error": "–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞"}
            return {"error": f"API error: {response.status_code}"}
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ GitHub API: {e}")
            return {"error": str(e)}
    
    def edit_file(self, file_path: str, new_content: str, commit_message: str) -> Dict:
        try:
            if not self.github_token or not self.repo_owner or not self.repo_name:
                return {"error": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é"}
            
            url = f"{self.BASE_URL}/repos/{self.repo_owner}/{self.repo_name}/contents/{file_path}"
            response = session.get(url, headers=self._get_headers())
            
            if response.status_code != 200:
                return {"error": "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"}
            
            current_file = response.json()
            sha = current_file["sha"]
            
            encoded_content = base64.b64encode(new_content.encode('utf-8')).decode('utf-8')
            
            data = {
                "message": commit_message,
                "content": encoded_content,
                "sha": sha
            }
            
            response = session.put(url, headers=self._get_headers(), json=data)
            return response.json()
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞: {e}")
            return {"error": str(e)}


class TelegramBot:
    THEMES = ["HR –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º", "PR –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏", "—Ä–µ–º–æ–Ω—Ç –∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ"]
    
    TIME_STYLES = {
        "11:00": {
            "name": "–£—Ç—Ä–µ–Ω–Ω–∏–π –ø–æ—Å—Ç",
            "type": "morning",
            "emoji": "üåÖ",
            "style": "—ç–Ω–µ—Ä–≥–æ—Å—Ç–∞—Ä—Ç: –∫–æ—Ä–æ—Ç–∫–∞—è –ø–æ–ª—å–∑–∞, –ª—ë–≥–∫–∞—è –¥–∏–Ω–∞–º–∏–∫–∞, –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π —Ñ–æ–∫—É—Å",
            "tg_chars": (400, 600),
            "zen_chars": (600, 700),
            "tg_tokens": (100, 135),
            "zen_tokens": (135, 155),
            "total_tokens": (235, 290)
        },
        "15:00": {
            "name": "–î–Ω–µ–≤–Ω—ã–π –ø–æ—Å—Ç",
            "type": "day",
            "emoji": "üåû",
            "style": "—Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞: –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ, —Ä–∞–∑–±–æ—Ä —è–≤–ª–µ–Ω–∏—è, –º–∏–∫—Ä–æ–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è",
            "tg_chars": (700, 900),
            "zen_chars": (700, 900),
            "tg_tokens": (155, 200),
            "zen_tokens": (155, 200),
            "total_tokens": (310, 400)
        },
        "20:00": {
            "name": "–í–µ—á–µ—Ä–Ω–∏–π –ø–æ—Å—Ç",
            "type": "evening",
            "emoji": "üåô",
            "style": "–≥–ª—É–±–∏–Ω–∞ –∏ –∏—Å—Ç–æ—Ä–∏—è: –ª–∏—á–Ω—ã–π –≤–∑–≥–ª—è–¥, –º–∏–Ω–∏–∏—Å—Ç–æ—Ä–∏—è, –∞–Ω–∞–ª–æ–≥–∏—è",
            "tg_chars": (600, 900),
            "zen_chars": (700, 800),
            "tg_tokens": (135, 200),
            "zen_tokens": (155, 180),
            "total_tokens": (290, 380)
        }
    }
    
    # ========== –†–ê–°–®–ò–†–ï–ù–ù–´–ï –°–ü–ò–°–ö–ò –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –ü–û–°–¢–û–í ==========
    APPROACHES = [
        "–ü—Ä–∏–º–µ—Ä –∏–∑ –ª–∏—á–Ω–æ–≥–æ –æ–ø—ã—Ç–∞",
        "–ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π –ª–∏—á–Ω—ã–π –ø—Ä–æ–≤–∞–ª",
        "–ö–æ—Ä–æ—Ç–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è ¬´–¥–æ / –ø–æ—Å–ª–µ¬ª",
        "–°–∏—Ç—É–∞—Ü–∏—è –∏–∑ —Ä–µ–∞–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã",
        "–û—à–∏–±–∫–∞, –∫–æ—Ç–æ—Ä—É—é —Å–æ–≤–µ—Ä—à–∞—é—Ç 80%",
        "–ù–µ–æ—á–µ–≤–∏–¥–Ω–æ–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ",
        "–ü–∞—Ä–∞–¥–æ–∫—Å –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏",
        "–°—Ü–µ–Ω–∫–∞ –∏–∑ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏",
        "–î–∏–∞–ª–æ–≥ (1‚Äì2 —Ä–µ–ø–ª–∏–∫–∏)",
        "–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–æ–Ω–æ–ª–æ–≥",
        "–†–µ–∑–∫–æ–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ",
        "–û–ø—Ä–æ–≤–µ—Ä–∂–µ–Ω–∏–µ –ø–æ–ø—É–ª—è—Ä–Ω–æ–≥–æ –º–Ω–µ–Ω–∏—è",
        "–§—Ä–∞–∑–∞ ¬´–í—Å–µ –¥—É–º–∞—é—Ç, —á—Ç–æ‚Ä¶, –Ω–æ‚Ä¶¬ª",
        "–¶–∏—Ç–∞—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞ / –∫–æ–ª–ª–µ–≥–∏",
        "–¶–∏—Ç–∞—Ç–∞ –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∞–≤—Ç–æ—Ä–∞",
        "–¶–∏—Ç–∞—Ç–∞ —Å –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–º –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ–º",
        "–¶–∏—Ñ—Ä–∞, –≤—ã—Ä–≤–∞–Ω–Ω–∞—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞",
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –≤—ã–≤–æ–¥–æ–º",
        "–§–∞–∫—Ç, –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∞—â–∏–π –∏–Ω—Ç—É–∏—Ü–∏–∏",
        "–§–∞–∫—Ç –∏–∑ –¥—Ä—É–≥–æ–π –∏–Ω–¥—É—Å—Ç—Ä–∏–∏",
        "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –±—ã—Ç–æ–≤–æ–π —Å–∏—Ç—É–∞—Ü–∏–µ–π",
        "–ú–µ—Ç–∞—Ñ–æ—Ä–∞",
        "–ò—Ä–æ–Ω–∏—á–Ω–æ–µ –ø—Ä–µ—É–≤–µ–ª–∏—á–µ–Ω–∏–µ",
        "–ù–∞–º—ë–∫ –Ω–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç",
        "–û–±–µ—â–∞–Ω–∏–µ –ø–æ–ª—å–∑—ã –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π",
        "–í–æ–ø—Ä–æ—Å –±–µ–∑ –∑–Ω–∞–∫–∞ –≤–æ–ø—Ä–æ—Å–∞",
        "–û—Ç—Ä–∏—Ü–∞–Ω–∏–µ (¬´–≠—Ç–æ –Ω–µ –ø—Ä–æ‚Ä¶¬ª)",
        "–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∑–∏—Å –≤ 3‚Äì4 —Å–ª–æ–≤–∞",
        "–°–ø–∏—Å–æ–∫ –∏–∑ –æ–¥–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞",
        "–û–±—Ä—ã–≤ —Ñ—Ä–∞–∑—ã",
        "–ü—Ä–∏–∑–Ω–∞–Ω–∏–µ —Å–ª–∞–±–æ—Å—Ç–∏",
        "–ü—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–æ–Ω—Å—Ç–∞—Ç–∞—Ü–∏—è",
        "–ò—Å—Ç–æ—Ä–∏—è ¬´–æ–¥–Ω–æ–≥–æ –∫–µ–π—Å–∞¬ª",
        "–ù–∞–±–ª—é–¥–µ–Ω–∏–µ –∑–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π",
        "–û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–∞–ø—Ä—è–º—É—é (¬´–í—ã –∑–∞–º–µ—á–∞–ª–∏‚Ä¶¬ª)",
        "–£—Ç–æ—á–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ (¬´–í 2025‚Ä¶¬ª)",
        "–†–µ—Ñ—Ä–µ–π–º –ø—Ä–∏–≤—ã—á–Ω–æ–π —Ç–µ–º—ã",
        "–ê–Ω—Ç–∏-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",
        "–ù–∞–º–µ—Ä–µ–Ω–Ω–æ–µ —É–ø—Ä–æ—â–µ–Ω–∏–µ —Å–ª–æ–∂–Ω–æ–≥–æ",
        "–ö–æ–Ω—Ç—Ä–∞—Å—Ç –æ–∂–∏–¥–∞–Ω–∏–π –∏ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏",
        "–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑–Ω—É—Ç—Ä–∏",
        "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–∏—Ä–æ–¥–Ω—ã–º —è–≤–ª–µ–Ω–∏–µ–º",
        "–ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è —Å –∏–∑–≤–µ—Å—Ç–Ω—ã–º —Ñ–∏–ª—å–º–æ–º/–∫–Ω–∏–≥–æ–π",
        "–ò—Å—Ç–æ—Ä–∏—è –Ω–µ—É–¥–∞—á–∏, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–≤–µ–ª–∞ –∫ —É—Å–ø–µ—Ö—É",
        "–°–æ–≤–µ—Ç –æ—Ç –Ω–∞—á–∏–Ω–∞—é—â–µ–≥–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞",
        "–í–∑–≥–ª—è–¥ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞",
        "–†–∞–∑–±–æ—Ä —Å—Ç–µ—Ä–µ–æ—Ç–∏–ø–∞",
        "–õ–∏—á–Ω–∞—è –º–∏—Å—Å–∏—è –≤ —Ä–∞–±–æ—Ç–µ",
        "–ú–æ–º–µ–Ω—Ç –æ–∑–∞—Ä–µ–Ω–∏—è –Ω–∞ —Ä–∞–±–æ—Ç–µ",
        "–ü—Ä–∏–Ω—Ü–∏–ø –∏–∑ —Å–ø–æ—Ä—Ç–∞",
        "–£—Ä–æ–∫ –∏–∑ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è",
        "–ë–∏–∑–Ω–µ—Å-–ª–µ–≥–µ–Ω–¥–∞",
        "–ö—É–ª—å—Ç—É—Ä–Ω–∞—è –∞–Ω–∞–ª–æ–≥–∏—è",
        "–ù–∞—É—á–Ω—ã–π —Ñ–∞–∫—Ç –≤ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏",
        "–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∑–∞–∫–æ–Ω –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ",
        "–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ç—Ä—é–∫",
        "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–π —Ö–æ–¥",
        "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–µ—Ç–∞–ª—å, –∫–æ—Ç–æ—Ä–∞—è –º–µ–Ω—è–µ—Ç –≤—Å—ë",
        "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä",
        "–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±—É–¥—É—â–µ–µ",
        "–ü—Ä–∏–Ω—Ü–∏–ø –∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã",
        "–ú—É–∑—ã–∫–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–æ–≥–∏—è",
        "–ö—É–ª–∏–Ω–∞—Ä–Ω–∞—è –º–µ—Ç–∞—Ñ–æ—Ä–∞",
        "–£—Ä–æ–∫ –∏–∑ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏—è –¥–µ—Ç–µ–π",
        "–ü—Ä–∏–Ω—Ü–∏–ø –∏–∑ –∏–≥—Ä—ã",
        "–ê–≤–∏–∞—Ü–∏–æ–Ω–Ω–∞—è –∞–Ω–∞–ª–æ–≥–∏—è",
        "–ú–æ—Ä—Å–∫–∞—è —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—è",
        "–í–æ–µ–Ω–Ω–∞—è —Ç–∞–∫—Ç–∏–∫–∞",
        "–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∞–Ω–∞–ª–æ–≥–∏—è",
        "–Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å",
        "–≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –º–µ—Ç–∞—Ñ–æ—Ä–∞",
        "–ö–æ—Å–º–∏—á–µ—Å–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ",
        "–î–æ—Ä–æ–∂–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è",
        "–°—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–æ–≥–∏—è",
        "–ò–¢-–º–µ—Ç–∞—Ñ–æ—Ä–∞",
        "–î–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π –ø—Ä–∏–Ω—Ü–∏–ø",
        "–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø—Ä–∏—ë–º",
        "–¢–µ–∞—Ç—Ä–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–æ–≥–∏—è",
        "–ö–∏–Ω–µ–º–∞—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥",
        "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Å—Ç–∏–ª—å",
        "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–Ω—Ü–∏–ø",
        "–¢–∞–Ω—Ü–µ–≤–∞–ª—å–Ω–∞—è –º–µ—Ç–∞—Ñ–æ—Ä–∞",
        "–°–ø–æ—Ä—Ç–∏–≤–Ω–∞—è —Ç–∞–∫—Ç–∏–∫–∞"
    ]
    
    QUESTION_TYPES = [
        "–ü–æ—á–µ–º—É –≤—ã –¥–æ —Å–∏—Ö –ø–æ—Ä –¥–µ–ª–∞–µ—Ç–µ —ç—Ç–æ —Ç–∞–∫?",
        "–ê –µ—Å–ª–∏ –≤—ã –ø—Ä–æ—Å—Ç–æ –æ—à–∏–±–∞–µ—Ç–µ—Å—å?",
        "–ö—Ç–æ –≤–∞–º —Å–∫–∞–∑–∞–ª, —á—Ç–æ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?",
        "–ó–∞—á–µ–º –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å, –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –Ω–µ—Ç?",
        "–ß—Ç–æ –≤—ã —Ç–µ—Ä—è–µ—Ç–µ, –Ω–µ –º–µ–Ω—è—è –ø–æ–¥—Ö–æ–¥?",
        "–ö–∞–∫ –≤—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ —ç—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ?",
        "–ß—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ –≤ —Ç–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–µ—Ä–≤—ã–º?",
        "–ö–∞–∫–æ–π —à–∞–≥ —É –≤–∞—Å –æ–±—ã—á–Ω–æ –≤—ã–ø–∞–¥–∞–µ—Ç?",
        "–ù–∞ —á—ë–º –≤—ã —ç–∫–æ–Ω–æ–º–∏—Ç–µ –≤—Ä–µ–º—è?",
        "–ß—Ç–æ —Ä–µ–∞–ª—å–Ω–æ –¥–∞—ë—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É –≤–∞—Å?",
        "–ß—Ç–æ –µ—Å–ª–∏ —É–±—Ä–∞—Ç—å —ç—Ç–æ—Ç —ç—Ç–∞–ø —Å–æ–≤—Å–µ–º?",
        "–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—Å—è, –µ—Å–ª–∏ —Å–¥–µ–ª–∞—Ç—å –Ω–∞–æ–±–æ—Ä–æ—Ç?",
        "–ê –µ—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ 10 –º–∏–Ω—É—Ç?",
        "–ß—Ç–æ –±—É–¥–µ—Ç —á–µ—Ä–µ–∑ –º–µ—Å—è—Ü –ø—Ä–∏ —Ç–æ–º –∂–µ –ø–æ–¥—Ö–æ–¥–µ?",
        "–ß—Ç–æ –µ—Å–ª–∏ —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –∑–∞–¥–∞—á—É –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç?",
        "–ß—Ç–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ: —Å–∫–æ—Ä–æ—Å—Ç—å –∏–ª–∏ —Ç–æ—á–Ω–æ—Å—Ç—å?",
        "–ß—Ç–æ –¥–∞—ë—Ç –±–æ–ª—å—à–∏–π —ç—Ñ—Ñ–µ–∫—Ç: —Å–∏—Å—Ç–µ–º–∞ –∏–ª–∏ —Ç–∞–ª–∞–Ω—Ç?",
        "–ì–¥–µ –≤—ã—à–µ –æ—Ç–¥–∞—á–∞: –∑–¥–µ—Å—å –∏–ª–∏ —Ç–∞–º?",
        "–ß—Ç–æ —Å–ª–æ–∂–Ω–µ–µ ‚Äî –Ω–∞—á–∞—Ç—å –∏–ª–∏ –Ω–µ –±—Ä–æ—Å–∏—Ç—å?",
        "–ß—Ç–æ –≤–∞–∂–Ω–µ–µ –Ω–∞ —Å—Ç–∞—Ä—Ç–µ, –∞ —á—Ç–æ ‚Äî –ø–æ–∑–∂–µ?",
        "–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –∫–∞–∂–µ—Ç—Å—è –≤–∞–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º?",
        "–ö–æ–≥–¥–∞ –≤—ã –ø–æ—Å–ª–µ–¥–Ω—ã–π —Ä–∞–∑ —ç—Ç–æ –ø–µ—Ä–µ—Å–º–∞—Ç—Ä–∏–≤–∞–ª–∏?",
        "–ß—Ç–æ –≤–∞—Å –≤ —ç—Ç–æ–º —Ä–∞–∑–¥—Ä–∞–∂–∞–µ—Ç?",
        "–ì–¥–µ –≤—ã —Å–µ–±–µ –≤—Ä—ë—Ç–µ?",
        "–í –∫–∞–∫–æ–π –º–æ–º–µ–Ω—Ç –≤—Å—ë –ª–æ–º–∞–µ—Ç—Å—è?",
        "–£–∑–Ω–∞—ë—Ç–µ —Å–µ–±—è?",
        "–ó–Ω–∞–∫–æ–º–∞—è —Å–∏—Ç—É–∞—Ü–∏—è?",
        "–ë—ã–ª–æ —Ç–∞–∫–æ–µ?",
        "–≠—Ç–æ –ø—Ä–æ –≤–∞—Å –∏–ª–∏ –Ω–µ—Ç?",
        "–°–µ–π—á–∞—Å –∫–∏–≤–Ω—É–ª–∏?",
        "–ß—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ, –∫–æ–≥–¥–∞ –≤—Å–µ –º–µ—Ç–æ–¥—ã –∏—Å—á–µ—Ä–ø–∞–Ω—ã?",
        "–ö–∞–∫–æ–π —à–∞–≥ –≤—ã –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç–µ —á–∞—â–µ –≤—Å–µ–≥–æ?",
        "–ß—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –º–æ—Ç–∏–≤–∏—Ä—É–µ—Ç –≤–∞—Å –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å?",
        "–ö–∞–∫–∞—è –º—ã—Å–ª—å –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤–∞—Å —á–∞—â–µ –≤—Å–µ–≥–æ?",
        "–ö–∞–∫ –≤—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç–µ —Ç–æ—á–∫—É –Ω–µ–≤–æ–∑–≤—Ä–∞—Ç–∞?",
        "–ß—Ç–æ –≤—ã –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ: —Ä–∏—Å–∫ –∏–ª–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å?",
        "–ö–∞–∫ –≤—ã –æ—Ç–ª–∏—á–∞–µ—Ç–µ –∏–Ω—Ç—É–∏—Ü–∏—é –æ—Ç —Å—Ç—Ä–∞—Ö–∞?",
        "–ß—Ç–æ –≤–∞—Å —É–¥–∏–≤–ª—è–µ—Ç –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –≤–∞—à–µ–π —Ä–∞–±–æ—Ç—ã?",
        "–ö–∞–∫ –≤—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç–µ—Å—å –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–∏?",
        "–ß—Ç–æ –≤—ã –∑–Ω–∞–µ—Ç–µ —Å–µ–≥–æ–¥–Ω—è, —á–µ–≥–æ –Ω–µ –∑–Ω–∞–ª–∏ –≥–æ–¥ –Ω–∞–∑–∞–¥?",
        "–ö–∞–∫–æ–π —Å–æ–≤–µ—Ç –≤—ã –±—ã –¥–∞–ª–∏ —Å–µ–±–µ –≤ –ø—Ä–æ—à–ª–æ–º?",
        "–ß—Ç–æ –∏–∑ –≤–∞—à–µ–≥–æ –æ–ø—ã—Ç–∞ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —Ç–µ–æ—Ä–∏–∏?",
        "–ö–∞–∫ –≤—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç–µ, —á—Ç–æ –ø–æ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è?",
        "–ß—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ, –∫–æ–≥–¥–∞ –Ω–µ—Ç —è—Å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞?",
        "–ö–∞–∫ –≤—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ —Ñ–æ–∫—É—Å —Å—Ä–µ–¥–∏ —Ö–∞–æ—Å–∞?",
        "–ß—Ç–æ –¥–ª—è –≤–∞—Å –∑–Ω–∞—á–∏—Ç ¬´–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à–æ¬ª?",
        "–ö–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏?",
        "–ß—Ç–æ –≤—ã –ø–µ—Ä–µ—Å—Ç–∞–ª–∏ –¥–µ–ª–∞—Ç—å, –∏ —ç—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ –≤—Å—ë?",
        "–ö–∞–∫–æ–π –≤–æ–ø—Ä–æ—Å –≤—ã –±–æ–∏—Ç–µ—Å—å –∑–∞–¥–∞—Ç—å —Å–µ–±–µ?",
        "–ß—Ç–æ –±—ã –≤—ã –¥–µ–ª–∞–ª–∏, –µ—Å–ª–∏ –±—ã –Ω–µ –±–æ—è–ª–∏—Å—å –æ—Ü–µ–Ω–∫–∏?",
        "–ö–∞–∫ –≤—ã –æ—Ç–ª–∏—á–∞–µ—Ç–µ —Ä–æ—Å—Ç –æ—Ç –∫–æ–º—Ñ–æ—Ä—Ç–∞?",
        "–ß—Ç–æ –≤—ã –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç–µ, –Ω–æ –∑–Ω–∞–µ—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å?",
        "–ö–∞–∫–æ–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —à–∞–≥ –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å —Å–∏—Ç—É–∞—Ü–∏—é?",
        "–ß—Ç–æ –≤—ã –≤–∏–¥–∏—Ç–µ, —á—Ç–æ –¥—Ä—É–≥–∏–µ –Ω–µ –∑–∞–º–µ—á–∞—é—Ç?",
        "–ö–∞–∫ –≤—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ —Ä–µ—à–µ–Ω–∏—è –≤ —É—Å–ª–æ–≤–∏—è—Ö –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏?",
        "–ß—Ç–æ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–µ–µ: –ø—Ä–æ—Ü–µ—Å—Å –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç?",
        "–ö–∞–∫ –≤—ã –ø–æ–Ω–∏–º–∞–µ—Ç–µ, —á—Ç–æ –¥–≤–∏–∂–µ—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏?",
        "–ß—Ç–æ –≤—ã –≥–æ—Ç–æ–≤—ã –æ—Ç–ø—É—Å—Ç–∏—Ç—å —Ä–∞–¥–∏ —Ä–æ—Å—Ç–∞?",
        "–ö–∞–∫–æ–π —É—Ä–æ–∫ –æ–∫–∞–∑–∞–ª—Å—è —Å–∞–º—ã–º —Ü–µ–Ω–Ω—ã–º?",
        "–ß—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ, –∫–æ–≥–¥–∞ –≤—Å–µ –≤–æ–∫—Ä—É–≥ —Å–æ–º–Ω–µ–≤–∞—é—Ç—Å—è?",
        "–ö–∞–∫ –≤—ã —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç–µ —è—Å–Ω–æ—Å—Ç—å –º—ã—à–ª–µ–Ω–∏–µ –ø–æ–¥ –¥–∞–≤–ª–µ–Ω–∏–µ–º?",
        "–ß—Ç–æ –∑–Ω–∞—á–∏—Ç ¬´—É—Å–ø–µ—Ö¬ª –∏–º–µ–Ω–Ω–æ –¥–ª—è –≤–∞—Å?",
        "–ö–∞–∫ –≤—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç–µ —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–¥–∞—á?",
        "–ß—Ç–æ –±—ã –≤—ã –∏–∑–º–µ–Ω–∏–ª–∏, –µ—Å–ª–∏ –±—ã –Ω–∞—á–∞–ª–∏ —Å–Ω–∞—á–∞–ª–∞?",
        "–ö–∞–∫–æ–π –Ω–∞–≤—ã–∫ –æ–∫–∞–∑–∞–ª—Å—è –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω—ã–º?",
        "–ß—Ç–æ –≤–∞—Å –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å, –∫–æ–≥–¥–∞ —Ç—Ä—É–¥–Ω–æ?",
        "–ö–∞–∫ –≤—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç–µ —Å–≤–æ–∏ –≥—Ä–∞–Ω–∏—Ü—ã?",
        "–ß—Ç–æ –¥–ª—è –≤–∞—Å –∑–Ω–∞—á–∏—Ç ¬´–±—ã—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º¬ª?",
        "–ö–∞–∫–æ–π –ø—Ä–∏–Ω—Ü–∏–ø –≤—ã –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω–∞—Ä—É—à–∏—Ç–µ?",
        "–ß—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ, –∫–æ–≥–¥–∞ —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç–µ—Å—å —Å —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ–º?",
        "–ö–∞–∫ –≤—ã —É—á–∏—Ç–µ—Å—å –Ω–∞ —Å–≤–æ–∏—Ö –æ—à–∏–±–∫–∞—Ö?",
        "–ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∞–º –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –≤ —Ä–µ—Å—É—Ä—Å–µ?",
        "–ö–∞–∫–æ–π –≤–æ–ø—Ä–æ—Å —Å—Ç–∞–≤–∏—Ç –≤–∞—Å –≤ —Ç—É–ø–∏–∫?",
        "–ß—Ç–æ –≤—ã —Ü–µ–Ω–∏—Ç–µ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤ —Å–≤–æ–µ–π —Ä–∞–±–æ—Ç–µ?",
        "–ö–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å –º–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å—é?",
        "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç –¥–ª—è –≤–∞—Å ¬´–∫–∞—á–µ—Å—Ç–≤–æ¬ª?",
        "–ö–∞–∫ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç—å –∏ –∫–∞—á–µ—Å—Ç–≤–æ?",
        "–ß—Ç–æ –±—ã –≤—ã –ø–æ—Å–æ–≤–µ—Ç–æ–≤–∞–ª–∏ —Ç–æ–º—É, –∫—Ç–æ —Ç–æ–ª—å–∫–æ –Ω–∞—á–∏–Ω–∞–µ—Ç?",
        "–ö–∞–∫–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –æ–∫–∞–∑–∞–ª—Å—è —Å–∞–º—ã–º –ø–æ–ª–µ–∑–Ω—ã–º?",
        "–ß—Ç–æ –∏–∑ —Ç–æ–≥–æ, —á—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ, –±—É–¥–µ—Ç –∞–∫—Ç—É–∞–ª—å–Ω–æ —á–µ—Ä–µ–∑ 5 –ª–µ—Ç?",
        "–ö–∞–∫ –≤—ã –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç–µ—Å—å –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º?",
        "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç ¬´–±—ã—Ç—å –ª–∏–¥–µ—Ä–æ–º¬ª –≤ –≤–∞—à–µ–π —Å—Ñ–µ—Ä–µ?",
        "–ö–∞–∫ –≤—ã —Å–ø—Ä–∞–≤–ª—è–µ—Ç–µ—Å—å —Å –∫—Ä–∏—Ç–∏–∫–æ–π?",
        "–ß—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è —Å–≤–æ–µ–≥–æ –º—ã—à–ª–µ–Ω–∏—è?",
        "–ö–∞–∫–æ–π –ø—Ä–∏–≤—ã—á–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≤—ã –ø–µ—Ä–µ—Å–º–æ—Ç—Ä–µ–ª–∏ –∏ —É–ª—É—á—à–∏–ª–∏?",
        "–ß—Ç–æ –¥–ª—è –≤–∞—Å –∑–Ω–∞—á–∏—Ç ¬´—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å¬ª –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ?",
        "–ö–∞–∫ –≤—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –≤ —É—Å–ª–æ–≤–∏—è—Ö —Ü–µ–π—Ç–Ω–æ—Ç–∞?",
        "–ß—Ç–æ –≤—ã –¥–µ–ª–∞–µ—Ç–µ, –∫–æ–≥–¥–∞ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –≤—ã–≥–æ—Ä–∞–Ω–∏–µ?",
        "–ö–∞–∫–æ–π —Ä–µ—Å—É—Ä—Å –æ–∫–∞–∑–∞–ª—Å—è —Å–∞–º—ã–º —Ü–µ–Ω–Ω—ã–º –¥–ª—è –æ–±—É—á–µ–Ω–∏—è?",
        "–ß—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –≤–∞–º –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç—Ä—É–¥–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è?",
        "–ö–∞–∫ –≤—ã –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç–µ –¥–æ–≤–µ—Ä–∏–µ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏?",
        "–ß—Ç–æ –≤—ã —Å—á–∏—Ç–∞–µ—Ç–µ —Å–≤–æ–∏–º –≥–ª–∞–≤–Ω—ã–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ–º?",
        "–ö–∞–∫–æ–π –≤—ã–∑–æ–≤ –æ–∫–∞–∑–∞–ª—Å—è —Å–∞–º—ã–º —Å–ª–æ–∂–Ω—ã–º?",
        "–ß—Ç–æ –¥–ª—è –≤–∞—Å –∑–Ω–∞—á–∏—Ç ¬´–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç¬ª?",
        "–ö–∞–∫ –≤—ã –∏–∑–º–µ—Ä—è–µ—Ç–µ —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å?",
        "–ß—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –ø–æ–Ω–∏–º–∞–ª–∏ –æ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç–µ?",
        "–ö–∞–∫–æ–π –∞—Å–ø–µ–∫—Ç –≤–∞—à–µ–π —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–Ω–æ—Å–∏—Ç –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏—è?"
    ]
    
    KEY_THOUGHTS = [
        "–û–¥–∏–Ω —Ç–µ–∑–∏—Å ‚Äî –æ–¥–∏–Ω –∞–±–∑–∞—Ü",
        "–ß—ë—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞ ‚Üí —á—ë—Ç–∫–æ–µ —Å–ª–µ–¥—Å—Ç–≤–∏–µ",
        "–§–æ—Ä–º—É–ª–∞ ¬´–µ—Å–ª–∏ ‚Äî —Ç–æ¬ª",
        "–ü—Ä—è–º–æ–π –≤—ã–≤–æ–¥ –±–µ–∑ —É–∫—Ä–∞—à–µ–Ω–∏–π",
        "–Ø—Å–Ω–æ–µ ¬´—ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç / —ç—Ç–æ –Ω–µ—Ç¬ª",
        "–ú—ã—Å–ª—å + –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —à–∞–≥",
        "–ú—ã—Å–ª—å + –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ",
        "–ú—ã—Å–ª—å + –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è",
        "–ú—ã—Å–ª—å + —Ç–∏–ø–∏—á–Ω–∞—è –æ—à–∏–±–∫–∞",
        "–ú—ã—Å–ª—å + —á–µ–∫-–ø–æ–π–Ω—Ç",
        "–ü–µ—Ä–µ–≤—ë—Ä–Ω—É—Ç—ã–π —Ç–µ–∑–∏—Å",
        "–ú—ã—Å–ª—å —á–µ—Ä–µ–∑ –æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ",
        "–ú—ã—Å–ª—å —á–µ—Ä–µ–∑ –º–µ—Ç–∞—Ñ–æ—Ä—É",
        "–ú—ã—Å–ª—å —á–µ—Ä–µ–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ",
        "–ú—ã—Å–ª—å —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–¥–æ–∫—Å",
        "–ë–µ–∑ —Å–ª–æ–≤–∞ ¬´–≤–∞–∂–Ω–æ¬ª, ¬´–Ω—É–∂–Ω–æ¬ª, ¬´—Å–ª–µ–¥—É–µ—Ç¬ª",
        "–ë–µ–∑ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π (¬´—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å¬ª, ¬´—Ü–µ–Ω–Ω–æ—Å—Ç—å¬ª)",
        "–ß–µ—Ä–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç",
        "–ß–µ—Ä–µ–∑ –¥–µ–π—Å—Ç–≤–∏–µ, –∞ –Ω–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ",
        "–ß–µ—Ä–µ–∑ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è, –∞ –Ω–µ –Ω–∞–º–µ—Ä–µ–Ω–∏—è",
        "–ú—ã—Å–ª—å + —Ä–∏—Å–∫",
        "–ú—ã—Å–ª—å + —Ü–µ–Ω–∞ –æ—à–∏–±–∫–∏",
        "–ú—ã—Å–ª—å + –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞",
        "–ú—ã—Å–ª—å + –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏",
        "–ú—ã—Å–ª—å + —Ç–æ—á–∫–∞ –Ω–µ–≤–æ–∑–≤—Ä–∞—Ç–∞",
        "–ú—ã—Å–ª—å –∫–∞–∫ –≤—ã–≤–æ–¥",
        "–ú—ã—Å–ª—å –∫–∞–∫ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ",
        "–ú—ã—Å–ª—å –∫–∞–∫ —Ä–∞–∑–≤–∏–ª–∫–∞",
        "–ú—ã—Å–ª—å –∫–∞–∫ —Ä–µ—à–µ–Ω–∏–µ",
        "–ú—ã—Å–ª—å –∫–∞–∫ –≤—ã–∑–æ–≤",
        "–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä ‚Üí —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø",
        "–û—Ç —á–∞—Å—Ç–Ω–æ–≥–æ —Å–ª—É—á–∞—è –∫ –æ–±—â–µ–º—É –ø—Ä–∞–≤–∏–ª—É",
        "–§–∞–∫—Ç ‚Üí –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è ‚Üí –¥–µ–π—Å—Ç–≤–∏–µ",
        "–ü—Ä–æ–±–ª–µ–º–∞ ‚Üí –ø—Ä–∏—á–∏–Ω–∞ ‚Üí —Ä–µ—à–µ–Ω–∏–µ",
        "–û–∂–∏–¥–∞–Ω–∏–µ ‚Üí —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å ‚Üí –∫–æ—Ä—Ä–µ–∫—Ü–∏—è",
        "–¶–µ–ª—å ‚Üí –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ ‚Üí –æ–±—Ö–æ–¥–Ω–æ–π –ø—É—Ç—å",
        "–¢—Ä–µ–Ω–¥ ‚Üí –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è ‚Üí –∞–¥–∞–ø—Ç–∞—Ü–∏—è",
        "–û—à–∏–±–∫–∞ ‚Üí –∞–Ω–∞–ª–∏–∑ ‚Üí –ø—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞",
        "–£—Å–ø–µ—Ö ‚Üí –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è ‚Üí –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ",
        "–ö–æ–Ω—Ñ–ª–∏–∫—Ç ‚Üí –ø–æ–Ω–∏–º–∞–Ω–∏–µ ‚Üí —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ",
        "–î–∞–Ω–Ω—ã–µ ‚Üí insight ‚Üí –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ",
        "–û–ø—ã—Ç ‚Üí —Ä–µ—Ñ–ª–µ–∫—Å–∏—è ‚Üí —Ä–∞–∑–≤–∏—Ç–∏–µ",
        "–ö—Ä–∏—Ç–∏–∫–∞ ‚Üí —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è ‚Üí —É–ª—É—á—à–µ–Ω–∏–µ",
        "–ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å ‚Üí –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ ‚Üí —Ä–µ—à–µ–Ω–∏–µ",
        "–î–∞–≤–ª–µ–Ω–∏–µ ‚Üí —Ñ–æ–∫—É—Å ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        "–°–ª–æ–∂–Ω–æ—Å—Ç—å ‚Üí —É–ø—Ä–æ—â–µ–Ω–∏–µ ‚Üí —è—Å–Ω–æ—Å—Ç—å",
        "–ú–Ω–æ–≥–æ–∑–∞–¥–∞—á–Ω–æ—Å—Ç—å ‚Üí –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è ‚Üí —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
        "–£—Å—Ç–∞–ª–æ—Å—Ç—å ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ ‚Üí –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
        "–†—É—Ç–∏–Ω–∞ ‚Üí –∏–Ω–Ω–æ–≤–∞—Ü–∏—è ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ",
        "–°—Ç–∞–Ω–¥–∞—Ä—Ç ‚Üí –∏—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Üí –ø—Ä–æ–≥—Ä–µ—Å—Å",
        "–¢–µ–æ—Ä–∏—è ‚Üí –ø—Ä–∞–∫—Ç–∏–∫–∞ ‚Üí –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞",
        "–ò–¥–µ–∞–ª ‚Üí —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å ‚Üí –±–∞–ª–∞–Ω—Å",
        "–°–∫–æ—Ä–æ—Å—Ç—å ‚Üí –∫–∞—á–µ—Å—Ç–≤–æ ‚Üí –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ—Å—Ç—å",
        "–†–∏—Å–∫ ‚Üí –æ—Ü–µ–Ω–∫–∞ ‚Üí –¥–µ–π—Å—Ç–≤–∏–µ",
        "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è ‚Üí –æ—Ç–¥–∞—á–∞ ‚Üí –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ",
        "–û–±—É—á–µ–Ω–∏–µ ‚Üí –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ ‚Üí –º–∞—Å—Ç–µ—Ä—Å—Ç–≤–æ",
        "–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è ‚Üí –ø–æ–Ω–∏–º–∞–Ω–∏–µ ‚Üí —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ",
        "–õ–∏–¥–µ—Ä—Å—Ç–≤–æ ‚Üí –≤–ª–∏—è–Ω–∏–µ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        "–ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Üí —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí —Ü–µ–Ω–Ω–æ—Å—Ç—å",
        "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è ‚Üí –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Üí –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ",
        "–ò–∑–º–µ–Ω–µ–Ω–∏–µ ‚Üí –∞–¥–∞–ø—Ç–∞—Ü–∏—è ‚Üí —Ä–æ—Å—Ç",
        "–ö—É–ª—å—Ç—É—Ä–∞ ‚Üí –ø–æ–≤–µ–¥–µ–Ω–∏–µ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        "–î–æ–≤–µ—Ä–∏–µ ‚Üí –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å ‚Üí –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ",
        "–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å ‚Üí —è—Å–Ω–æ—Å—Ç—å ‚Üí –¥–æ–≤–µ—Ä–∏–µ",
        "–ì–∏–±–∫–æ—Å—Ç—å ‚Üí –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Üí —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å",
        "–§–æ–∫—É—Å ‚Üí –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è ‚Üí –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ",
        "–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ ‚Üí –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí —É—Å–ø–µ—Ö",
        "–≠–º–ø–∞—Ç–∏—è ‚Üí –ø–æ–Ω–∏–º–∞–Ω–∏–µ ‚Üí –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ",
        "–ê–Ω–∞–ª–∏–∑ ‚Üí insight ‚Üí —Å—Ç—Ä–∞—Ç–µ–≥–∏—è",
        "–≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚Üí –≤—ã–≤–æ–¥",
        "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è ‚Üí —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Üí —ç–∫–æ–Ω–æ–º–∏—è",
        "–ò–Ω–Ω–æ–≤–∞—Ü–∏—è ‚Üí –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ ‚Üí –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ",
        "–°–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–æ ‚Üí —Å–∏–Ω–µ—Ä–≥–∏—è ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å ‚Üí ownership ‚Üí –∫–∞—á–µ—Å—Ç–≤–æ",
        "–ü—Ä–æ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Üí –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        "–†–µ—Ñ–ª–µ–∫—Å–∏—è ‚Üí –æ—Å–æ–∑–Ω–∞–Ω–∏–µ ‚Üí —Ä–∞–∑–≤–∏—Ç–∏–µ",
        "–ë–∞–ª–∞–Ω—Å ‚Üí –≥–∞—Ä–º–æ–Ω–∏—è ‚Üí —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å",
        "–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å ‚Üí recovery ‚Üí —Ä–æ—Å—Ç",
        "–ü—Ä–æ—Å—Ç–æ—Ç–∞ ‚Üí —è—Å–Ω–æ—Å—Ç—å ‚Üí —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å",
        "–ì–ª—É–±–∏–Ω–∞ ‚Üí –ø–æ–Ω–∏–º–∞–Ω–∏–µ ‚Üí —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞",
        "–®–∏—Ä–æ—Ç–∞ ‚Üí –æ–±–∑–æ—Ä ‚Üí –∫–æ–Ω—Ç–µ–∫—Å—Ç",
        "–î–µ—Ç–∞–ª—å ‚Üí —Ç–æ—á–Ω–æ—Å—Ç—å ‚Üí –∫–∞—á–µ—Å—Ç–≤–æ",
        "–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å ‚Üí —Å–∏—Å—Ç–µ–º–Ω–æ—Å—Ç—å ‚Üí –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å",
        "–ì–∏–±—Ä–∏–¥ ‚Üí –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Üí —Å–∏–ª–∞",
        "–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí –≥–ª—É–±–∏–Ω–∞ ‚Üí —Ü–µ–Ω–Ω–æ—Å—Ç—å",
        "–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ—Å—Ç—å ‚Üí –≥–∏–±–∫–æ—Å—Ç—å ‚Üí –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å",
        "–¢—Ä–∞–¥–∏—Ü–∏—è ‚Üí —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å ‚Üí –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å",
        "–ù–æ–≤–∏–∑–Ω–∞ ‚Üí —Å–≤–µ–∂–µ—Å—Ç—å ‚Üí –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å",
        "–°–∫–æ—Ä–æ—Å—Ç—å ‚Üí –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Üí –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ",
        "–ö–∞—á–µ—Å—Ç–≤–æ ‚Üí excellence ‚Üí —Ä–µ–ø—É—Ç–∞—Ü–∏—è",
        "–≠–∫–æ–Ω–æ–º–∏—è ‚Üí —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Üí –ø—Ä–∏–±—ã–ª—å",
        "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏—è ‚Üí —Ä–∞–∑–≤–∏—Ç–∏–µ ‚Üí –±—É–¥—É—â–µ–µ",
        "–û–±—É—á–µ–Ω–∏–µ ‚Üí —Ä–æ—Å—Ç ‚Üí –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª",
        "–ú–æ—Ç–∏–≤–∞—Ü–∏—è ‚Üí —ç–Ω–µ—Ä–≥–∏—è ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        "–í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ ‚Üí —Ç–≤–æ—Ä—á–µ—Å—Ç–≤–æ ‚Üí –∏–Ω–Ω–æ–≤–∞—Ü–∏—è",
        "–î–æ–≤–µ—Ä–∏–µ ‚Üí –ª–æ—è–ª—å–Ω–æ—Å—Ç—å ‚Üí –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ—Å—Ç—å",
        "–†–µ–ø—É—Ç–∞—Ü–∏—è ‚Üí –¥–æ–≤–µ—Ä–∏–µ ‚Üí –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏",
        "–°–µ—Ç—å ‚Üí —Å–≤—è–∑–∏ ‚Üí –¥–æ—Å—Ç—É–ø",
        "–ó–Ω–∞–Ω–∏–µ ‚Üí —Å–∏–ª–∞ ‚Üí –≤–ª–∏—è–Ω–∏–µ",
        "–û–ø—ã—Ç ‚Üí –º—É–¥—Ä–æ—Å—Ç—å ‚Üí –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ—à–µ–Ω–∏–π",
        "–ò–Ω—Ç—É–∏—Ü–∏—è ‚Üí —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å ‚Üí —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å",
        "–õ–æ–≥–∏–∫–∞ ‚Üí —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Üí —è—Å–Ω–æ—Å—Ç—å",
        "–≠–º–æ—Ü–∏—è ‚Üí –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å ‚Üí —ç–Ω–µ—Ä–≥–∏—è",
        "–î–∞–Ω–Ω—ã–µ ‚Üí –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ‚Üí —Ç–æ—á–Ω–æ—Å—Ç—å",
        "–ò—Å—Ç–æ—Ä–∏—è ‚Üí –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Üí –ø–æ–Ω–∏–º–∞–Ω–∏–µ",
        "–ë—É–¥—É—â–µ–µ ‚Üí –≤–∏–¥–µ–Ω–∏–µ ‚Üí –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
        "–ù–∞—Å—Ç–æ—è—â–µ–µ ‚Üí –¥–µ–π—Å—Ç–≤–∏–µ ‚Üí —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
        "–ü—Ä–æ—à–ª–æ–µ ‚Üí —É—Ä–æ–∫ ‚Üí —Ä–∞–∑–≤–∏—Ç–∏–µ"
    ]
    
    def __init__(self, target_slot: str = None, auto: bool = False):
        self.target_slot = target_slot
        self.auto = auto
        self.bot = telebot.TeleBot(BOT_TOKEN, parse_mode='HTML')
        self.github_manager = GitHubAPIManager()
        self.pending_posts: Dict[int, Dict] = {}
        self.post_history = self._load_json("post_history.json", {
            "sent_slots": {},
            "rejected_slots": {},
            "generated_texts": [],
            "used_approaches": [],
            "used_questions": [],
            "used_key_thoughts": []
        })
        self.image_history = self._load_json("image_history.json", {
            "used_images": []
        })
        self.current_theme = None
        self.current_format = None
        self.current_style = None
        self.published_posts_count = 0
        self.workflow_complete = False
        self.stop_polling = False
        self.publish_lock = threading.Lock()
        self.completion_lock = threading.Lock()
        self.polling_lock = threading.Lock()
        self.polling_thread = None
        
        self.callback_handlers = {
            "publish": self._handle_approval,
            "reject": self._handle_rejection,
            "edit_text": lambda msg_id, post_data, call: self._handle_edit_request(msg_id, post_data, call, "–ø–µ—Ä–µ–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç"),
            "edit_photo": lambda msg_id, post_data, call: self._handle_edit_request(msg_id, post_data, call, "–∑–∞–º–µ–Ω–∏ —Ñ–æ—Ç–æ"),
            "edit_all": lambda msg_id, post_data, call: self._handle_edit_request(msg_id, post_data, call, "–ø–µ—Ä–µ–¥–µ–ª–∞–π –ø–æ–ª–Ω–æ—Å—Ç—å—é"),
            "new_post": self._handle_new_post_request,
            "back_to_main": self._handle_back_to_main
        }
    
    # ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ ==========
    def _load_json(self, filename: str, default_data: Dict) -> Dict:
        try:
            if os.path.exists(filename):
                with open(filename, 'r', encoding='utf-8') as f:
                    return json.load(f)
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ {filename}: {e}")
        return default_data
    
    def _save_json(self, filename: str, data: Dict) -> bool:
        try:
            with open(filename, 'w', encoding='utf-8') as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
            return True
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è {filename}: {e}")
            return False
    
    def get_moscow_time(self) -> datetime:
        return datetime.utcnow() + timedelta(hours=3)
    
    def _clean_metadata(self, text: str, post_type: str) -> str:
        """–£–¥–∞–ª—è–µ—Ç –º–∞—Ä–∫–µ—Ä—ã –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—Å—Ç–∞"""
        if not text:
            return text
        
        lines = []
        for line in text.split('\n'):
            line = line.strip()
            if not line:
                lines.append('')
                continue
            
            # –£–¥–∞–ª—è–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é —Ç–∏–ø–∞ [1], [2], [3], [4] –∏ —Ç.–¥.
            line = re.sub(r'^\[\d+\]\s*', '', line)
            
            # –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫–∏ —Ç–∏–ø–∞ "–ó–ê–ì–û–õ–û–í–û–ö:", "–ê–ë–ó–ê–¶ 1:", "–ê–ë–ó–ê–¶ 2:", "–ö–õ–Æ–ß–ï–í–ê–Ø –ú–´–°–õ–¨:", "–í–û–ü–†–û–°:", "–•–ï–®–¢–ï–ì–ò:" –∏ —Ç.–¥.
            markers_to_remove = [
                '–∑–∞–≥–æ–ª–æ–≤–æ–∫:', '–∞–±–∑–∞—Ü 1:', '–∞–±–∑–∞—Ü 2:', '–∫–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å:', '–≤–æ–ø—Ä–æ—Å:', '—Ö–µ—à—Ç–µ–≥–∏:',
                '—è–∫–æ—Ä—å:', '–≤ –∏—Ç–æ–≥–µ:', 'anchor:', 'header:', 'paragraph:', 'key thought:',
                'question:', 'hashtags:', '–∞–±–∑–∞—Ü:', '–±–ª–æ–∫:', '–±–ª–æ–∫ 1:', '–±–ª–æ–∫ 2:', '–±–ª–æ–∫ 3:', '–±–ª–æ–∫ 4:', '–±–ª–æ–∫ 5:',
                '–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞', '–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞:', '–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞:', '–ø–ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞'
            ]
            
            for marker in markers_to_remove:
                if line.lower().startswith(marker):
                    # –£–¥–∞–ª—è–µ–º –º–µ—Ç–∫—É, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –¥–≤–æ–µ—Ç–æ—á–∏—è
                    parts = line.split(':', 1)
                    if len(parts) > 1:
                        line = parts[1].strip()
                    else:
                        line = line[len(marker):].strip()
                    break
            
            # –£–¥–∞–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏ '[' –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏
            if line.startswith('['):
                line = re.sub(r'^\[', '', line)
            
            # –£–¥–∞–ª—è–µ–º —Ü–∏—Ñ—Ä—ã –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "5" –ø–æ—Å–ª–µ —Ö–µ—à—Ç–µ–≥–æ–≤)
            if line.isdigit() and len(line) <= 2:
                continue
            
            # Telegram: —Å–æ—Ö—Ä–∞–Ω—è–µ–º —ç–º–æ–¥–∑–∏ –≤ –Ω–∞—á–∞–ª–µ
            if post_type == 'telegram' and self.current_style:
                emoji = self.current_style.get('emoji', '')
                if emoji and line.startswith(emoji):
                    # –û—Å—Ç–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏ + –∑–∞–≥–æ–ª–æ–≤–æ–∫
                    pass
            
            # Telegram: –ù–ï —É–¥–∞–ª—è—Ç—å —Ö–µ—à—Ç–µ–≥–∏
            if post_type == 'telegram' and line.startswith('#'):
                # –û—Å—Ç–∞–≤–ª—è–µ–º —Ö–µ—à—Ç–µ–≥–∏ –∫–∞–∫ –µ—Å—Ç—å
                lines.append(line)
                continue
            
            # Zen: –ù–ï —É–¥–∞–ª—è—Ç—å —Ö–µ—à—Ç–µ–≥–∏
            if post_type == 'zen' and line.startswith('#'):
                # –û—Å—Ç–∞–≤–ª—è–µ–º —Ö–µ—à—Ç–µ–≥–∏ –∫–∞–∫ –µ—Å—Ç—å
                lines.append(line)
                continue
            
            # –£–¥–∞–ª—è–µ–º —Ç–µ–≥–∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è HTML, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
            if post_type == 'telegram':
                line = re.sub(r'<[^>]+>', '', line)
            
            lines.append(line)
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ, —É–±–∏—Ä–∞—è –ª–∏—à–Ω–∏–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
        cleaned_text = '\n'.join(lines)
        
        # –£–±–∏—Ä–∞–µ–º –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ (–±–æ–ª—å—à–µ 2 –ø–æ–¥—Ä—è–¥)
        cleaned_text = re.sub(r'\n\s*\n\s*\n+', '\n\n', cleaned_text)
        
        # Telegram: –µ—Å–ª–∏ —É–±—Ä–∞–ª–∏—Å—å –≤—Å–µ —Ö–µ—à—Ç–µ–≥–∏, –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
        if post_type == 'telegram' and not re.search(r'#\w+', cleaned_text):
            if self.current_theme:
                theme_words = [word.strip() for word in self.current_theme.split() if len(word.strip()) > 2]
                if theme_words:
                    hashtags = '#' + ' #'.join([re.sub(r'[^\w]', '', word.lower()) for word in theme_words[:3]])
                else:
                    hashtags = "#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #–ø—Ä–∞–∫—Ç–∏–∫–∞ #—Ä–µ–∑—É–ª—å—Ç–∞—Ç"
                
                cleaned_text = cleaned_text.strip()
                if not cleaned_text.endswith('\n'):
                    cleaned_text += '\n\n'
                cleaned_text += hashtags
        
        # Zen: –µ—Å–ª–∏ —É–±—Ä–∞–ª–∏—Å—å –≤—Å–µ —Ö–µ—à—Ç–µ–≥–∏, –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ
        if post_type == 'zen' and not re.search(r'#\w+', cleaned_text):
            if self.current_theme:
                theme_words = [word.strip() for word in self.current_theme.split() if len(word.strip()) > 2]
                if theme_words:
                    hashtags = '#' + ' #'.join([re.sub(r'[^\w]', '', word.lower()) for word in theme_words[:3]])
                else:
                    hashtags = "#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #–ø—Ä–∞–∫—Ç–∏–∫–∞ #—Ä–µ–∑—É–ª—å—Ç–∞—Ç"
                
                cleaned_text = cleaned_text.strip()
                if not cleaned_text.endswith('\n'):
                    cleaned_text += '\n\n'
                cleaned_text += hashtags
        
        return cleaned_text.strip()
    
    def _get_text_hash(self, text: str) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç —Ö–µ—à —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏"""
        # –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏ –∏ –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        clean_text = re.sub(r'[^\w\s#?]', '', text.lower())
        clean_text = re.sub(r'\s+', ' ', clean_text).strip()
        return hashlib.md5(clean_text.encode('utf-8')).hexdigest()
    
    def _is_duplicate_text(self, text: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—ã–ª –ª–∏ —Ç–∞–∫–æ–π —Ç–µ–∫—Å—Ç —É–∂–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"""
        text_hash = self._get_text_hash(text)
        generated_texts = self.post_history.get("generated_texts", [])
        return text_hash in generated_texts
    
    def _add_to_generated_texts(self, text: str):
        """–î–æ–±–∞–≤–ª—è–µ—Ç —Ö–µ—à —Ç–µ–∫—Å—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        text_hash = self._get_text_hash(text)
        if "generated_texts" not in self.post_history:
            self.post_history["generated_texts"] = []
        
        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 500 —Ç–µ–∫—Å—Ç–æ–≤
        if len(self.post_history["generated_texts"]) >= 500:
            self.post_history["generated_texts"] = self.post_history["generated_texts"][-250:]
        
        if text_hash not in self.post_history["generated_texts"]:
            self.post_history["generated_texts"].append(text_hash)
            self._save_json("post_history.json", self.post_history)
    
    def _get_fresh_approach(self) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–≤–µ–∂–∏–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è –ø–æ—Å—Ç–∞"""
        used = self.post_history.get("used_approaches", [])
        available = [a for a in self.APPROACHES if a not in used]
        
        if not available:
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö
            self.post_history["used_approaches"] = []
            available = self.APPROACHES
        
        chosen = random.choice(available)
        self.post_history["used_approaches"].append(chosen)
        self._save_json("post_history.json", self.post_history)
        return chosen
    
    def _get_fresh_question(self) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–≤–µ–∂–∏–π –≤–æ–ø—Ä–æ—Å –¥–ª—è –ø–æ—Å—Ç–∞"""
        used = self.post_history.get("used_questions", [])
        available = [q for q in self.QUESTION_TYPES if q not in used]
        
        if not available:
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö
            self.post_history["used_questions"] = []
            available = self.QUESTION_TYPES
        
        chosen = random.choice(available)
        self.post_history["used_questions"].append(chosen)
        self._save_json("post_history.json", self.post_history)
        return chosen
    
    def _get_fresh_key_thought(self) -> str:
        """–ü–æ–ª—É—á–∞–µ—Ç —Å–≤–µ–∂—É—é –∫–ª—é—á–µ–≤—É—é –º—ã—Å–ª—å –¥–ª—è –ø–æ—Å—Ç–∞"""
        used = self.post_history.get("used_key_thoughts", [])
        available = [k for k in self.KEY_THOUGHTS if k not in used]
        
        if not available:
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö
            self.post_history["used_key_thoughts"] = []
            available = self.KEY_THOUGHTS
        
        chosen = random.choice(available)
        self.post_history["used_key_thoughts"].append(chosen)
        self._save_json("post_history.json", self.post_history)
        return chosen
    
    # ========== –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –ü–†–û–ú–ü–¢–´ ==========
    def create_telegram_prompt(self, theme: str, slot_style: Dict, text_format: str, image_description: str) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è Telegram –ø–æ—Å—Ç–∞"""
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π seed –¥–ª—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
        random_seed = random.randint(1, 10000)
        
        # –ü–æ–ª—É—á–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ç–æ–∫–µ–Ω–∞–º
        tg_token_min, tg_token_max = slot_style['tg_tokens']
        tg_char_min, tg_char_max = slot_style['tg_chars']
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ—Å—Ç–∞
        approach = self._get_fresh_approach()
        question_type = self._get_fresh_question()
        key_thought = self._get_fresh_key_thought()
        
        prompt = f"""
–¢–û–ß–ù–´–ô –§–û–†–ú–ê–¢ ‚Äî –ù–ï –£–î–ê–õ–Ø–ô –ù–ò–ö–ê–ö–ò–ï –ë–õ–û–ö–ò:

[1] {slot_style['emoji']} –ó–ê–ì–û–õ–û–í–û–ö: –°–æ–∑–¥–∞–π –ø—Ä–æ–≤–æ–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ —Ç–µ–º–µ "{theme}". –ù–∞—á–Ω–∏ —Å—Ä–∞–∑—É —Å —ç–º–æ–¥–∑–∏ {slot_style['emoji']}. –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ç–µ–∫—Å—Ç—ã.

[2] –ê–ë–ó–ê–¶ 1: {approach}. –°–≤–æ–±–æ–¥–Ω—ã–π –≤—Ö–æ–¥ –≤ –º—ã—Å–ª—å –∏ –Ω–µ–±–æ–ª—å—à–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ. 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã.

[3] üéØ –ö–õ–Æ–ß–ï–í–ê–Ø –ú–´–°–õ–¨: {key_thought}. –ù–∞—á–Ω–∏ —Å üéØ. 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –ø–æ-–Ω–æ–≤–æ–º—É, –∏–∑–±–µ–≥–∞—è —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ñ—Ä–∞–∑.

[4] –í–û–ü–†–û–°: {question_type}. –ó–∞–¥–∞–π –ü–û–õ–ù–´–ô, –ó–ê–ö–û–ù–ß–ï–ù–ù–´–ô –≤–æ–ø—Ä–æ—Å —á–∏—Ç–∞—Ç–µ–ª—é. –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞. –ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∑–Ω–∞–∫–æ–º ?. –í–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞ –∏ –±—ã—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º.

[5] –•–ï–®–¢–ï–ì–ò: –î–æ–±–∞–≤—å 3-5 —Ö–µ—à—Ç–µ–≥–æ–≤ –ø–æ —Ç–µ–º–µ. –¢–æ–ª—å–∫–æ #—Å–ª–æ–≤–æ #—Å–ª–æ–≤–æ #—Å–ª–æ–≤–æ.

–¢–ï–ú–ê: {theme}
RANDOM_SEED: {random_seed}
–û–ë–©–ï–ï –ö–û–õ–ò–ß–ï–°–¢–í–û –¢–û–ö–ï–ù–û–í –î–õ–Ø –í–°–ï–ì–û –ü–û–°–¢–ê: {tg_token_min}-{tg_token_max} —Ç–æ–∫–µ–Ω–æ–≤
–ú–ê–ö–°–ò–ú–ê–õ–¨–ù–ê–Ø –î–õ–ò–ù–ê –¢–ï–ö–°–¢–ê: {tg_char_max} –°–ò–ú–í–û–õ–û–í –í–ö–õ–Æ–ß–ê–Ø –•–ï–®–¢–ï–ì–ò

–ñ–ï–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
1. –ù–∞—á–∏–Ω–∞–π –°–†–ê–ó–£ —Å {slot_style['emoji']} –∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞
2. –ó–∞–≥–æ–ª–æ–≤–æ–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º
3. –ü–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
4. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–π üéØ –¥–ª—è –∫–ª—é—á–µ–≤–æ–π –º—ã—Å–ª–∏
5. –ú–µ–∂–¥—É –≤—Å–µ–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ [1]-[5] –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
6. –í–æ–ø—Ä–æ—Å –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∑–Ω–∞–∫–æ–º ? –∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–õ–ù–´–ú –ò –ó–ê–ö–û–ù–ß–ï–ù–ù–´–ú
7. –•–µ—à—Ç–µ–≥–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –ù–ï –£–î–ê–õ–Ø–ô –ò–• –ü–†–ò –ß–ò–°–¢–ö–ï
8. –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–æ–±–∞–≤–ª—è–π —Ü–∏—Ñ—Ä—ã –ø–æ—Å–ª–µ —Ö–µ—à—Ç–µ–≥–æ–≤ –∏–ª–∏ –≤ –∫–æ–Ω—Ü–µ –ø–æ—Å—Ç–∞
9. –°–ª–µ–¥—É–π —Å—Ç—Ä–æ–≥–æ –ø–æ—Ä—è–¥–∫—É [1]-[5]
10. –ò–∑–±–µ–≥–∞–π –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏
11. –í–û–ü–†–û–° –í –ë–õ–û–ö–ï [4] –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ü–û–õ–ù–û–¶–ï–ù–ù–´–ú, –ó–ê–ö–û–ù–ß–ï–ù–ù–´–ú –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï–ú –° –ó–ù–ê–ö–û–ú ? –í –ö–û–ù–¶–ï
12. –£–ë–ï–î–ò–°–¨, –ß–¢–û –í–°–ï 5 –ë–õ–û–ö–û–í –£–ú–ï–©–ê–Æ–¢–°–Ø –í {tg_token_min}-{tg_token_max} –¢–û–ö–ï–ù–û–í
13. –ï–°–õ–ò –ù–ï –•–í–ê–¢–ê–ï–¢ –¢–û–ö–ï–ù–û–í - –°–û–ö–†–ê–¢–ò –ü–†–ï–î–´–î–£–©–ò–ï –ë–õ–û–ö–ò, –ù–û –ù–ï –û–ë–†–ï–ó–ê–ô –ü–û–°–õ–ï–î–ù–ò–ô
14. –ü–û–°–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –ü–û–õ–ù–´–ú –ò –ó–ê–ö–û–ù–ß–ï–ù–ù–´–ú
15. –ù–ò–ö–ê–ö–ò–• –û–ë–†–ï–ó–ê–ù–ù–´–• –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ô –ò–õ–ò –ù–ï–ó–ê–ö–û–ù–ß–ï–ù–ù–´–• –ú–´–°–õ–ï–ô
16. –ü–†–ò –ù–ï–û–ë–•–û–î–ò–ú–û–°–¢–ò –°–î–ï–õ–ê–ô –ê–ë–ó–ê–¶ 1 –ò–õ–ò –ó–ê–ì–û–õ–û–í–û–ö –ö–û–†–û–ß–ï, –ù–û –°–û–•–†–ê–ù–ò –í–°–ï 5 –ë–õ–û–ö–û–í –ü–û–õ–ù–´–ú–ò
17. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–æ–±–ª—é–¥–∞–π –ª–∏–º–∏—Ç –≤ {tg_char_max} —Å–∏–º–≤–æ–ª–æ–≤ - –Ω–µ –ø—Ä–µ–≤—ã—à–∞–π –µ–≥–æ –Ω–∏ –Ω–∞ –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª
18. –ù–ò–ö–û–ì–î–ê –Ω–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞–π –ø–æ—Å—Ç —Ü–∏—Ñ—Ä–æ–π 5 –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ü–∏—Ñ—Ä–æ–π
19. –•–ï–®–¢–ï–ì–ò –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –í –ü–û–°–õ–ï–î–ù–ï–ô –°–¢–†–û–ö–ï –ò –ù–ï –ë–£–î–£–¢ –£–î–ê–õ–ï–ù–´ –ü–†–ò –ß–ò–°–¢–ö–ï
"""
        return prompt.strip()
    
    def create_zen_prompt(self, theme: str, slot_style: Dict, text_format: str, image_description: str) -> str:
        """–°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è Zen –ø–æ—Å—Ç–∞ - –ñ–ï–°–¢–ö–ê–Ø –°–¢–†–£–ö–¢–£–†–ê –° –í–û–ü–†–û–°–ê–ú–ò"""
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π seed –¥–ª—è –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏
        random_seed = random.randint(1, 10000)
        
        zen_min_chars, zen_max_chars = slot_style['zen_chars']
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ—Å—Ç–∞
        approach = self._get_fresh_approach()
        question_type = self._get_fresh_question()
        key_thought = self._get_fresh_key_thought()
        
        prompt = f"""
–¢–û–ß–ù–´–ô –§–û–†–ú–ê–¢ ‚Äî –ù–ï –£–î–ê–õ–Ø–ô –ù–ò–ö–ê–ö–ò–ï –ë–õ–û–ö–ò:

[1] –ó–ê–ì–û–õ–û–í–û–ö: –í–æ–ø—Ä–æ—Å –ø–æ —Ç–µ–º–µ "{theme}". –ó–ê–ö–û–ù–ß–ï–ù–ù–´–ô –≤–æ–ø—Ä–æ—Å —Å–æ –∑–Ω–∞–∫–æ–º ? –≤ –∫–æ–Ω—Ü–µ. 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.

[2] –í–û–ü–†–û–°: {question_type}. –ó–∞–¥–∞–π –ü–û–õ–ù–´–ô, –ó–ê–ö–û–ù–ß–ï–ù–ù–´–ô –≤–æ–ø—Ä–æ—Å —á–∏—Ç–∞—Ç–µ–ª—é. –û—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞. –ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∑–Ω–∞–∫–æ–º ?. –í–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞.

[3] –û–°–ù–û–í–ù–û–ô –¢–ï–ö–°–¢: {approach}. 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ø—Ä–∏–º–µ—Ä–æ–º. –ü–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–∫–æ–Ω—á–µ–Ω–Ω–∞—è –º—ã—Å–ª—å. –ö–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ.

[4] –ö–õ–Æ–ß–ï–í–ê–Ø –ú–´–°–õ–¨: {key_thought}. 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è. –í—ã–≤–æ–¥ –∏–ª–∏ –∏—Ç–æ–≥.

[5] –•–ï–®–¢–ï–ì–ò: 3-5 —Ö–µ—à—Ç–µ–≥–æ–≤ –ø–æ —Ç–µ–º–µ. –¢–æ–ª—å–∫–æ #—Å–ª–æ–≤–æ #—Å–ª–æ–≤–æ #—Å–ª–æ–≤–æ.

–¢–ï–ú–ê: {theme}
RANDOM_SEED: {random_seed}
–î–õ–ò–ù–ê –¢–ï–ö–°–¢–ê: {zen_min_chars}-{zen_max_chars} –°–ò–ú–í–û–õ–û–í –í–ö–õ–Æ–ß–ê–Ø –•–ï–®–¢–ï–ì–ò (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!)

–ñ–ï–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
1. –ù–∞—á–∏–Ω–∞–π –°–†–ê–ó–£ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞
2. –ó–∞–≥–æ–ª–æ–≤–æ–∫ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∑–Ω–∞–∫–æ–º ?
3. –ü–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
4. –í–æ–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–õ–ù–´–ú, –ó–ê–ö–û–ù–ß–ï–ù–ù–´–ú –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º —Å–æ –∑–Ω–∞–∫–æ–º ? –≤ –∫–æ–Ω—Ü–µ
5. –ü–æ—Å–ª–µ –≤–æ–ø—Ä–æ—Å–∞ –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
6. –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç: –ö–ê–ñ–î–û–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –ù–ê –ù–û–í–û–ô –°–¢–†–û–ö–ï
7. –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ó–ê–ö–û–ù–ß–ï–ù–ù–´–ú, –Ω–µ –æ–±—Ä—ã–≤–∞—Ç—å—Å—è –Ω–∞ –ø–æ–ª—É—Å–ª–æ–≤–µ
8. –ü–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
9. –ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å - —ç—Ç–æ –≤—ã–≤–æ–¥ –∏–ª–∏ –∏—Ç–æ–≥
10. –ü–æ—Å–ª–µ –∫–ª—é—á–µ–≤–æ–π –º—ã—Å–ª–∏ –æ—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
11. –•–µ—à—Ç–µ–≥–∏ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –ù–ï –£–î–ê–õ–Ø–ô –ò–• –ü–†–ò –ß–ò–°–¢–ö–ï
12. –ù–ò–ö–ê–ö–ò–• —ç–º–æ–¥–∑–∏, —Å–º–∞–π–ª–∏–∫–æ–≤, –º–∞—Ä–∫–µ—Ä–æ–≤ –∫—Ä–æ–º–µ [1]-[5]
13. –ù–ò–ö–ê–ö–ò–• –æ–±—Ä–µ–∑–∞–Ω–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
14. –¢–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ü–û–õ–ù–´–ú –∏ –ó–ê–ö–û–ù–ß–ï–ù–ù–´–ú
15. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —Å–æ–±–ª—é–¥–∞–π –ª–∏–º–∏—Ç –≤ {zen_min_chars}-{zen_max_chars} —Å–∏–º–≤–æ–ª–æ–≤
16. –ï–°–õ–ò –¢–ï–ö–°–¢ –ö–û–†–û–ß–ï {zen_min_chars} –°–ò–ú–í–û–õ–û–í - –î–û–ü–ò–®–ò –û–°–ù–û–í–ù–û–ô –¢–ï–ö–°–¢
17. –ï–°–õ–ò –¢–ï–ö–°–¢ –î–õ–ò–ù–ù–ï–ï {zen_max_chars} –°–ò–ú–í–û–õ–û–í - –°–û–ö–†–ê–¢–ò –û–°–ù–û–í–ù–û–ô –¢–ï–ö–°–¢
18. –ù–ï –ó–ê–í–ï–†–®–ê–ô –¢–ï–ö–°–¢ –¶–ò–§–†–ê–ú–ò
19. –°–ª–µ–¥—É–π —Å—Ç—Ä–æ–≥–æ –ø–æ—Ä—è–¥–∫—É [1]-[5]
20. –•–ï–®–¢–ï–ì–ò –î–û–õ–ñ–ù–´ –ë–´–¢–¨ –í –ü–û–°–õ–ï–î–ù–ï–ô –°–¢–†–û–ö–ï –ò –ù–ï –ë–£–î–£–¢ –£–î–ê–õ–ï–ù–´ –ü–†–ò –ß–ò–°–¢–ö–ï
21. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –í –û–°–ù–û–í–ù–û–ú –¢–ï–ö–°–¢–ï –ö–ê–ñ–î–û–ï –ü–†–ï–î–õ–û–ñ–ï–ù–ò–ï –° –ù–û–í–û–ô –°–¢–†–û–ö–ò

–ü–†–ò–ú–ï–† –§–û–†–ú–ê–¢–ê:
–ö–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –Ω–∞–∏–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω –≤ –¥–∞–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏?

–ö–∞–∫ –≤—ã –æ–±—ã—á–Ω–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç–µ –≤ –ø–æ–¥–æ–±–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö?

–ü–µ—Ä–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
–í—Ç–æ—Ä–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
–¢—Ä–µ—Ç—å–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.

–ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å: –≤–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥.

#—Ç–µ–º–∞ #—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #–ø—Ä–∞–∫—Ç–∏–∫–∞
"""
        return prompt.strip()
    
    def generate_with_gemini(self, prompt: str, post_type: str) -> Optional[str]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Gemini API"""
        try:
            if post_type == 'telegram':
                token_range = self.current_style.get('tg_tokens', (80, 120)) if self.current_style else (80, 120)
                max_tokens = token_range[1]
            else:
                token_range = self.current_style.get('zen_tokens', (120, 140)) if self.current_style else (120, 140)
                max_tokens = token_range[1]
            
            url = f"https://generativelanguage.googleapis.com/v1beta/models/gemma-3-27b-it:generateContent?key={GEMINI_API_KEY}"
            
            data = {
                "contents": [{"parts": [{"text": prompt}]}],
                "generationConfig": {
                    "temperature": 0.85,
                    "topP": 0.9,
                    "topK": 40,
                    "maxOutputTokens": max_tokens,
                }
            }
            
            response = session.post(url, json=data, timeout=60)
            
            if response.status_code == 200:
                result = response.json()
                if 'candidates' in result and result['candidates']:
                    generated_text = result['candidates'][0]['content']['parts'][0]['text']
                    logger.info(f"‚úÖ {post_type.upper()} —Ç–µ–∫—Å—Ç –ø–æ–ª—É—á–µ–Ω, –¥–ª–∏–Ω–∞: {len(generated_text)} —Å–∏–º–≤–æ–ª–æ–≤")
                    
                    # –°—Ä–∞–∑—É –æ—á–∏—â–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                    cleaned_text = self._clean_metadata(generated_text, post_type)
                    
                    return cleaned_text.strip()
            
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ API: {response.status_code}")
            return None
            
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ {post_type}: {e}")
            return None
    
    def validate_post_structure(self, text: str, post_type: str, slot_style: Dict = None) -> Tuple[bool, str]:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ—Å—Ç–∞ - –°–¢–†–û–ì–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø –î–õ–Ø –î–ó–ï–ù –° –í–û–ü–†–û–°–ê–ú–ò"""
        if not text:
            return False, "–ü—É—Å—Ç–æ–π —Ç–µ–∫—Å—Ç"
        
        # –û—á–∏—Å—Ç–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        cleaned_text = self._clean_metadata(text, post_type)
        
        # –î–õ–Ø –î–ó–ï–ù: –°–¢–†–û–ì–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø –ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–¢–†–£–ö–¢–£–†–´ –° –í–û–ü–†–û–°–ê–ú–ò
        if post_type == 'zen':
            lines = [line.strip() for line in cleaned_text.split('\n')]
            
            # –£–¥–∞–ª—è–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
            while lines and not lines[0]:
                lines.pop(0)
            while lines and not lines[-1]:
                lines.pop()
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            sections = []
            current_section = []
            
            for line in lines:
                if line:
                    current_section.append(line)
                elif current_section:
                    sections.append('\n'.join(current_section))
                    current_section = []
            
            if current_section:
                sections.append('\n'.join(current_section))
            
            # –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞: –∑–∞–≥–æ–ª–æ–≤–æ–∫ + –≤–æ–ø—Ä–æ—Å + –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç + –∫–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å + —Ö–µ—à—Ç–µ–≥–∏
            if len(sections) < 3:
                return False, "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–ª–æ–∫–æ–≤"
            
            # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            if len(sections) == 1:
                # –¢–æ–ª—å–∫–æ –æ–¥–∏–Ω –±–ª–æ–∫ - –¥–µ–ª–∞–µ–º –∏–∑ –Ω–µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏
                single_text = sections[0]
                sentences = re.split(r'(?<=[.!?])\s+', single_text)
                
                if len(sentences) >= 4:
                    sections = [
                        sentences[0] + ("?" if not sentences[0].endswith('?') else ""),
                        sentences[1] + ("?" if not sentences[1].endswith('?') else ""),
                        '\n'.join(sentences[2:-1]),
                        sentences[-1]
                    ]
                else:
                    sections = [
                        single_text + "?",
                        "–ö–∞–∫ –≤—ã –æ–±—ã—á–Ω–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç–µ –≤ –ø–æ–¥–æ–±–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö?",
                        "–ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–∞–∂–Ω–æ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞.\n–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –≤—Å–µ —Ñ–∞–∫—Ç–æ—Ä—ã –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —É—Å–ø–µ—Ö–∞.\n–ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –æ–ø—ã—Ç –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.",
                        "–ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å: –≤–∞–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥—Ö–æ–¥ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º."
                    ]
            elif len(sections) == 2:
                # –î–≤–∞ –±–ª–æ–∫–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ–º
                sections = [
                    sections[0] + ("?" if not sections[0].endswith('?') else ""),
                    "–ö–∞–∫ –≤—ã –æ–±—ã—á–Ω–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç–µ –≤ –ø–æ–¥–æ–±–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö?",
                    sections[1],
                    "–ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å: –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –≤—Å–µ —Ñ–∞–∫—Ç–æ—Ä—ã –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —É—Å–ø–µ—Ö–∞."
                ]
            
            # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –≤–æ–ø—Ä–æ—Å–æ–º
            if sections and not sections[0].endswith('?'):
                sections[0] = sections[0].rstrip('.!') + '?'
            
            # –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –µ—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å
            if len(sections) > 1 and not sections[1].endswith('?'):
                sections.insert(1, "–ö–∞–∫ –≤—ã –æ–±—ã—á–Ω–æ —Ä–µ–∞–≥–∏—Ä—É–µ—Ç–µ –≤ –ø–æ–¥–æ–±–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö?")
            
            # –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç: –∫–∞–∂–¥–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
            if len(sections) > 2:
                main_text = sections[2]
                # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                sentences = re.split(r'(?<=[.!?])\s+', main_text)
                if len(sentences) > 1:
                    sections[2] = '\n'.join(sentences)
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ö–µ—à—Ç–µ–≥–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
            has_hashtags = any('#' in section for section in sections)
            if not has_hashtags:
                # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–º—É –¥–ª—è —Ö–µ—à—Ç–µ–≥–æ–≤
                theme_words = []
                if self.current_theme:
                    theme_words = [word.strip() for word in self.current_theme.split() if len(word.strip()) > 2]
                
                if theme_words:
                    hashtags = '#' + ' #'.join([re.sub(r'[^\w]', '', word.lower()) for word in theme_words[:3]])
                else:
                    hashtags = "#—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #–ø—Ä–∞–∫—Ç–∏–∫–∞ #—Ä–µ–∑—É–ª—å—Ç–∞—Ç"
                
                sections.append(hashtags)
            
            # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
            structured_lines = []
            for i, section in enumerate(sections):
                if section:
                    structured_lines.append(section)
                    if i < len(sections) - 1:  # –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞, –∫—Ä–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ, –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
                        structured_lines.append("")
            
            cleaned_text = '\n'.join(structured_lines).strip()
        
        return True, cleaned_text
    
    def check_post_complete(self, text: str, post_type: str, slot_style: Dict = None) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –ø–æ—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã"""
        if not text:
            return False
        
        text_length = len(text)
        
        if post_type == 'telegram':
            # Telegram: –æ–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
            if not slot_style:
                return False
            
            tg_min, tg_max = slot_style['tg_chars']
            
            if not (tg_min <= text_length <= tg_max):
                logger.warning(f"‚ö†Ô∏è Telegram –ø–æ—Å—Ç –Ω–µ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–ª–∏–Ω—ã: {text_length} ({tg_min}-{tg_max})")
                return False
            
            lines = [line.strip() for line in text.split('\n') if line.strip()]
            
            if slot_style and 'emoji' in slot_style:
                if lines and not lines[0].startswith(slot_style['emoji']):
                    logger.warning(f"‚ö†Ô∏è Telegram –ø–æ—Å—Ç –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —ç–º–æ–¥–∑–∏ {slot_style['emoji']}")
                    return False
            
            has_question = any('?' in line for line in lines)
            if not has_question:
                logger.warning(f"‚ö†Ô∏è Telegram –ø–æ—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–æ–ø—Ä–æ—Å–∞!")
                return False
            
            has_hashtags = any(line.startswith('#') for line in lines)
            if not has_hashtags:
                logger.warning(f"‚ö†Ô∏è Telegram –ø–æ—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–µ—à—Ç–µ–≥–æ–≤!")
                return False
            
            return True
        
        elif post_type == 'zen':
            # Zen: –û–°–ù–û–í–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê - –ó–ê–ö–û–ù–ß–ï–ù–ù–û–°–¢–¨ –¢–ï–ö–°–¢–ê –ò –°–¢–†–£–ö–¢–£–†–ê
            if not slot_style:
                zen_min, zen_max = 600, 800
            else:
                zen_min, zen_max = slot_style['zen_chars']
            
            # –°–¢–†–û–ì–ê–Ø –ü–†–û–í–ï–†–ö–ê –î–õ–ò–ù–´
            if text_length < zen_min:
                logger.warning(f"‚ùå Zen –ø–æ—Å—Ç –°–õ–ò–®–ö–û–ú –ö–û–†–û–¢–ö–ò–ô: {text_length} < {zen_min} (–ù–ï –ü–†–ò–ù–ò–ú–ê–ï–ú!)")
                return False
            
            if text_length > zen_max + 100:  # +100 –¥–æ–ø—É—Å–∫
                logger.warning(f"‚ö†Ô∏è Zen –ø–æ—Å—Ç –°–õ–ò–®–ö–û–ú –î–õ–ò–ù–ù–´–ô: {text_length} > {zen_max}+100 (–Ω–æ –ø—Ä–∏–º–µ–º —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º)")
            
            # –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–í–ï–†–ö–ê: —Ç–µ–∫—Å—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –æ–±—Ä—ã–≤–∞—Ç—å—Å—è
            lines = [line.strip() for line in text.split('\n')]
            last_line = lines[-1] if lines else ""
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞ –Ω–µ –æ–±—Ä—ã–≤–∞–µ—Ç—Å—è
            if last_line and not last_line.endswith(('.', '!', '?', '#')):
                logger.warning(f"‚ùå Zen –ø–æ—Å—Ç –û–ë–†–´–í–ê–ï–¢–°–Ø: '{last_line[-50:]}...' (–ù–ï –ü–†–ò–ù–ò–ú–ê–ï–ú!)")
                return False
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Å –≤–æ–ø—Ä–æ—Å–æ–º
            first_non_empty = next((line for line in lines if line), "")
            if first_non_empty and not first_non_empty.endswith('?'):
                logger.warning("‚ö†Ô∏è Zen –ø–æ—Å—Ç: –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–æ–ø—Ä–æ—Å–∞")
                # –ù–ï –ü–†–ï–ö–†–ê–©–ê–ï–ú - –∏—Å–ø—Ä–∞–≤–∏–º –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                pass
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–æ—Ç—è –±—ã –¥–≤—É—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ (–∑–∞–≥–æ–ª–æ–≤–æ–∫ + –æ—Ç–¥–µ–ª—å–Ω—ã–π –≤–æ–ø—Ä–æ—Å)
            question_count = sum(1 for line in lines if '?' in line)
            if question_count < 1:
                logger.warning("‚ö†Ô∏è Zen –ø–æ—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ–Ω–µ–µ 1 –≤–æ–ø—Ä–æ—Å–∞")
                # –ù–ï –ü–†–ï–ö–†–ê–©–ê–ï–ú - –¥–æ–±–∞–≤–∏–º –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                pass
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ö–µ—à—Ç–µ–≥–æ–≤
            has_hashtags = any(line.startswith('#') for line in lines)
            if not has_hashtags:
                logger.warning("‚ö†Ô∏è Zen –ø–æ—Å—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–µ—à—Ç–µ–≥–æ–≤")
                # –ù–ï –ü–†–ï–ö–†–ê–©–ê–ï–ú - –¥–æ–±–∞–≤–∏–º –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
                pass
            
            # –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ê–í–ò–õ–û: —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª–∏–Ω–Ω—ã–º
            if text_length < 500:  # –ê–±—Å–æ–ª—é—Ç–Ω—ã–π –º–∏–Ω–∏–º—É–º
                logger.warning(f"‚ùå Zen –ø–æ—Å—Ç –°–õ–ò–®–ö–û–ú –ö–û–†–û–¢–ö–ò–ô: {text_length} < 500 (–ê–ë–°–û–õ–Æ–¢–ù–´–ô –ú–ò–ù–ò–ú–£–ú!)")
                return False
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É: –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–∑–¥–µ–ª–µ–Ω –Ω–∞ —Å—Ç—Ä–æ–∫–∏
            main_text_started = False
            has_multiline_main_text = False
            for line in lines:
                if line and '?' not in line and not line.startswith('#') and not line.lower().startswith('–∫–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å'):
                    main_text_started = True
                elif main_text_started and not line:
                    has_multiline_main_text = True
                    break
            
            if not has_multiline_main_text and text_length > 300:
                logger.warning("‚ö†Ô∏è Zen –ø–æ—Å—Ç: –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –Ω–∞–ø–∏—Å–∞–Ω —Å–ª–∏—Ç–Ω–æ, –±–µ–∑ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–æ–∫–∏")
                # –ù–ï –ü–†–ï–ö–†–ê–©–ê–ï–ú - –∏—Å–ø—Ä–∞–≤–∏–º –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
            
            return True
        
        return False
    
    def generate_with_retry(self, theme: str, slot_style: Dict, text_format: str, image_description: str,
                           max_attempts: int = 5) -> Tuple[Optional[str], Optional[str]]:
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏"""
        tg_min, tg_max = slot_style['tg_chars']
        zen_min, zen_max = slot_style['zen_chars']
        
        tg_text = None
        zen_text = None
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Telegram –ø–æ—Å—Ç
        logger.info("ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Telegram –ø–æ—Å—Ç–∞...")
        for attempt in range(max_attempts):
            logger.info(f"ü§ñ Telegram –ø–æ–ø—ã—Ç–∫–∞ {attempt+1}/{max_attempts}")
            
            tg_prompt = self.create_telegram_prompt(theme, slot_style, text_format, image_description)
            generated_tg = self.generate_with_gemini(tg_prompt, 'telegram')
            
            if generated_tg:
                valid, fixed_tg = self.validate_post_structure(generated_tg, 'telegram', slot_style)
                
                if valid:
                    if self._is_duplicate_text(fixed_tg):
                        logger.warning(f"‚ö†Ô∏è Telegram –ø–æ—Å—Ç - –¥—É–±–ª–∏–∫–∞—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –ø—ã—Ç–∞—é—Å—å —Å–Ω–æ–≤–∞...")
                        time.sleep(1)
                        continue
                    
                    tg_length = len(fixed_tg)
                    is_complete = self.check_post_complete(fixed_tg, 'telegram', slot_style)
                    
                    if tg_min <= tg_length <= tg_max and is_complete:
                        self._add_to_generated_texts(fixed_tg)
                        tg_text = fixed_tg
                        logger.info(f"‚úÖ Telegram —É—Å–ø–µ—Ö! {tg_length} —Å–∏–º–≤–æ–ª–æ–≤")
                        break
                    else:
                        logger.warning(f"‚ö†Ô∏è Telegram –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É: –¥–ª–∏–Ω–∞={tg_length}({tg_min}-{tg_max}), –ø–æ–ª–Ω—ã–π={is_complete}")
            
            if attempt < max_attempts - 1:
                time.sleep(1)
        
        if not tg_text:
            logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Telegram –ø–æ—Å—Ç")
            return None, None
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Zen –ø–æ—Å—Ç
        logger.info("ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è Zen –ø–æ—Å—Ç–∞...")
        
        for attempt in range(max_attempts):
            logger.info(f"ü§ñ Zen –ø–æ–ø—ã—Ç–∫–∞ {attempt+1}/{max_attempts}")
            
            zen_prompt = self.create_zen_prompt(theme, slot_style, text_format, image_description)
            generated_zen = self.generate_with_gemini(zen_prompt, 'zen')
            
            if generated_zen:
                valid, fixed_zen = self.validate_post_structure(generated_zen, 'zen')
                
                if valid:
                    if self._is_duplicate_text(fixed_zen):
                        logger.warning(f"‚ö†Ô∏è Zen –ø–æ—Å—Ç - –¥—É–±–ª–∏–∫–∞—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω, –ø—ã—Ç–∞—é—Å—å —Å–Ω–æ–≤–∞...")
                        time.sleep(1)
                        continue
                    
                    zen_length = len(fixed_zen)
                    is_complete = self.check_post_complete(fixed_zen, 'zen', slot_style)
                    
                    # –°–¢–†–û–ì–ê–Ø –ü–†–û–í–ï–†–ö–ê –î–õ–ò–ù–´ –î–õ–Ø ZEN
                    if zen_min <= zen_length <= zen_max + 100 and is_complete:  # +100 –¥–æ–ø—É—Å–∫
                        self._add_to_generated_texts(fixed_zen)
                        zen_text = fixed_zen
                        logger.info(f"‚úÖ Zen —É—Å–ø–µ—Ö! {zen_length} —Å–∏–º–≤–æ–ª–æ–≤ (–Ω—É–∂–Ω–æ {zen_min}-{zen_max})")
                        break
                    else:
                        logger.warning(f"‚ùå Zen –Ω–µ –ø—Ä–æ—à–µ–ª –ø—Ä–æ–≤–µ—Ä–∫—É –ø–æ –¥–ª–∏–Ω–µ: {zen_length} (–Ω—É–∂–Ω–æ {zen_min}-{zen_max}), –ø–æ–ª–Ω—ã–π={is_complete}")
            
            if attempt < max_attempts - 1:
                time.sleep(1)
        
        # –ï—Å–ª–∏ Zen –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª—Å—è - —Å–æ–∑–¥–∞–µ–º –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø–æ—Å—Ç —Å –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω–æ–π –ò –°–¢–†–£–ö–¢–£–†–û–ô –° –í–û–ü–†–û–°–ê–ú–ò
        if not zen_text:
            logger.warning("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Zen –ø–æ—Å—Ç, —Å–æ–∑–¥–∞—é –ü–†–ê–í–ò–õ–¨–ù–´–ô –ø–æ—Å—Ç —Å –Ω—É–∂–Ω–æ–π –¥–ª–∏–Ω–æ–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏...")
            
            reliable_zen = f"""–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∂–∞–ª–æ–±—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –Ω–∞ –ø—Ä–µ–¥–≤–∑—è—Ç–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è?

–ö–∞–∫ –≤—ã –æ–±—ã—á–Ω–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç–µ –≤ –ø–æ–¥–æ–±–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö?

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã—Å–ª—É—à–∞—Ç—å –≤—Å–µ —Å—Ç–æ—Ä–æ–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ.
–í–∞–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å —Ñ–∞–∫—Ç—ã –∏ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –ø—Ä–µ–¥–≤–∑—è—Ç–æ–≥–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è.
–°–ª–µ–¥—É–µ—Ç –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É —Å —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–º –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏.
–ù—É–∂–Ω–æ —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–µ–¥–≤–∑—è—Ç–æ—Å—Ç–∏.
–í–∞–∂–Ω–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ—Å—Ç—Ä–∞–¥–∞–≤—à–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º.

–ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å: –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –ø–æ–º–æ–≥–∞—é—Ç —Ä–∞–∑—Ä–µ—à–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å –¥–æ–≤–µ—Ä–∏–µ –≤ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–µ.

#{theme.replace(' ', '_').lower() if theme else '—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'} #–ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º #–∫–æ–Ω—Ñ–ª–∏–∫—Ç #—Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ"""
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            current_length = len(reliable_zen)
            if current_length < zen_min:
                # –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç
                additional_content = "–°–ª–µ–¥—É–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–µ—Ç–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –æ—Ü–µ–Ω–∫–∏ —Ä–∞–±–æ—Ç—ã –¥–ª—è –≤—Å–µ—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.\n–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–æ–¥–∏—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ —Ç—Ä–µ–Ω–∏–Ω–≥–∏ –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–µ–π.\n–í–∞–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤.\n"
                # –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ "–ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å:"
                if "–ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å:" in reliable_zen:
                    parts = reliable_zen.split("–ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å:")
                    reliable_zen = parts[0] + additional_content + "\n\n–ö–ª—é—á–µ–≤–∞—è –º—ã—Å–ª—å:" + parts[1]
            
            zen_text = reliable_zen
            logger.info(f"‚úÖ –°–æ–∑–¥–∞–Ω –ü–†–ê–í–ò–õ–¨–ù–´–ô Zen –ø–æ—Å—Ç —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏: {len(zen_text)} —Å–∏–º–≤–æ–ª–æ–≤ (–Ω—É–∂–Ω–æ {zen_min}-{zen_max})")
        
        return tg_text, zen_text
    
    def regenerate_single_post(self, post_type: str, theme: str, slot_style: Dict, image_description: str) -> Optional[str]:
        """–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ–¥–∏–Ω –ø–æ—Å—Ç"""
        try:
            logger.info(f"üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è {post_type} –ø–æ—Å—Ç–∞...")
            
            for attempt in range(3):
                if post_type == 'telegram':
                    prompt = self.create_telegram_prompt(theme, slot_style, "—Ä–∞–∑–±–æ—Ä —Å–∏—Ç—É–∞—Ü–∏–∏", image_description)
                else:
                    prompt = self.create_zen_prompt(theme, slot_style, "—Ä–∞–∑–±–æ—Ä —Å–∏—Ç—É–∞—Ü–∏–∏", image_description)
                
                generated_text = self.generate_with_gemini(prompt, post_type)
                
                if generated_text:
                    valid, fixed_text = self.validate_post_structure(generated_text, post_type, slot_style if post_type == 'telegram' else None)
                    if valid:
                        if not self._is_duplicate_text(fixed_text):
                            is_complete = self.check_post_complete(fixed_text, post_type, slot_style if post_type == 'telegram' else None)
                            if is_complete:
                                self._add_to_generated_texts(fixed_text)
                                logger.info(f"‚úÖ {post_type} –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!")
                                return fixed_text
                        else:
                            logger.warning(f"‚ö†Ô∏è {post_type} –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è - –¥—É–±–ª–∏–∫–∞—Ç, –ø—Ä–æ–±—É—é —Å–Ω–æ–≤–∞...")
                            time.sleep(1)
                            continue
            
            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å {post_type} –ø–æ—Å—Ç –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫")
            return None
            
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ {post_type}: {e}")
            return None
    
    # ========== –û–°–¢–ê–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ ==========
    def get_post_image_and_description(self, theme: str) -> Tuple[Optional[str], str]:
        """–ù–∞—Ö–æ–¥–∏—Ç –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É"""
        try:
            theme_queries = {
                "—Ä–µ–º–æ–Ω—Ç –∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ": ["construction", "renovation", "architecture"],
                "HR –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º": ["office", "business", "teamwork"],
                "PR –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏": ["communication", "marketing", "media"]
            }
            
            queries = theme_queries.get(theme, ["business", "professional"])
            query = random.choice(queries)
            
            logger.info(f"üîç –ò—â–µ–º —Ñ–æ—Ç–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É: '{query}'")
            
            if PEXELS_API_KEY:
                url = "https://api.pexels.com/v1/search"
                params = {"query": query, "per_page": 10, "orientation": "landscape"}
                headers = {"Authorization": PEXELS_API_KEY}
                
                response = session.get(url, params=params, headers=headers, timeout=10)
                if response.status_code == 200:
                    data = response.json()
                    photos = data.get("photos", [])
                    if photos:
                        used = self.image_history.get("used_images", [])
                        available = [p for p in photos if p.get("src", {}).get("large") not in used]
                        photo = random.choice(available if available else photos)
                        
                        image_url = photo.get("src", {}).get("large", "")
                        if image_url:
                            if "used_images" not in self.image_history:
                                self.image_history["used_images"] = []
                            self.image_history["used_images"].append(image_url)
                            self._save_json("image_history.json", self.image_history)
                            
                            return image_url, f"–§–æ—Ç–æ –Ω–∞ —Ç–µ–º—É '{query}'"
            
            encoded_query = quote_plus(query)
            unsplash_url = f"https://source.unsplash.com/featured/1200x630/?{encoded_query}"
            
            response = session.head(unsplash_url, timeout=5, allow_redirects=True)
            if response.status_code == 200:
                return response.url, f"–§–æ—Ç–æ –Ω–∞ —Ç–µ–º—É '{query}'"
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏: {e}")
        
        return None, "–ù–µ—Ç –∫–∞—Ä—Ç–∏–Ω–∫–∏"
    
    def create_inline_keyboard(self) -> InlineKeyboardMarkup:
        """–°–æ–∑–¥–∞–µ—Ç inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É"""
        keyboard = InlineKeyboardMarkup(row_width=3)
        keyboard.add(
            InlineKeyboardButton("‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å", callback_data="publish"),
            InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data="reject"),
            InlineKeyboardButton("üìù –¢–µ–∫—Å—Ç", callback_data="edit_text")
        )
        keyboard.add(
            InlineKeyboardButton("üñºÔ∏è –§–æ—Ç–æ", callback_data="edit_photo"),
            InlineKeyboardButton("üîÅ –í—Å—ë", callback_data="edit_all"),
            InlineKeyboardButton("‚ö° –ù–æ–≤–æ–µ", callback_data="new_post")
        )
        return keyboard
    
    # ========== CALLBACK –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ==========
    def _handle_callback(self, call: CallbackQuery):
        """–û—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ callback"""
        try:
            if not self._is_admin_message(call.message):
                return
            
            message_id = call.message.message_id
            callback_data = call.data
            
            if message_id not in self.pending_posts:
                return
            
            post_data = self.pending_posts[message_id]
            
            if callback_data.startswith("theme_"):
                self._handle_theme_selection(message_id, post_data, call, callback_data)
                return
            
            if callback_data in self.callback_handlers:
                self.callback_handlers[callback_data](message_id, post_data, call)
                
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback: {e}")
    
    def _handle_approval(self, message_id: int, post_data: Dict, call: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∏—è –ø–æ—Å—Ç–∞"""
        try:
            self.bot.answer_callback_query(call.id, "‚úÖ –ü–æ—Å—Ç –æ–¥–æ–±—Ä–µ–Ω!")
            
            try:
                status_text = f"\n\n<b>‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ {post_data.get('channel', '–∫–∞–Ω–∞–ª')}</b>"
                text_to_show = post_data.get('text', '') + status_text
                
                if 'image_url' in post_data and post_data['image_url']:
                    try:
                        self.bot.edit_message_caption(
                            chat_id=ADMIN_CHAT_ID,
                            message_id=message_id,
                            caption=text_to_show[:1020],
                            parse_mode='HTML',
                            reply_markup=None
                        )
                    except Exception as caption_error:
                        logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å caption: {caption_error}")
                        try:
                            self.bot.edit_message_text(
                                chat_id=ADMIN_CHAT_ID,
                                message_id=message_id,
                                text=text_to_show,
                                parse_mode='HTML',
                                reply_markup=None
                            )
                        except Exception as text_error:
                            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: {text_error}")
                else:
                    self.bot.edit_message_text(
                        chat_id=ADMIN_CHAT_ID,
                        message_id=message_id,
                        text=text_to_show,
                        parse_mode='HTML',
                        reply_markup=None
                    )
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
            
            success = self._publish_to_channel(
                post_data.get('text', ''),
                post_data.get('image_url', ''),
                post_data.get('channel', '')
            )
            
            if success:
                post_data['status'] = PostStatus.PUBLISHED
                post_data['published_at'] = datetime.now().isoformat()
                
                with self.publish_lock:
                    self.published_posts_count += 1
                    
                    if self.published_posts_count >= 2:
                        with self.completion_lock:
                            self.workflow_complete = True
            
            if message_id in self.pending_posts:
                del self.pending_posts[message_id]
                
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–æ–±—Ä–µ–Ω–∏—è: {e}")
    
    def _handle_rejection(self, message_id: int, post_data: Dict, call: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –ø–æ—Å—Ç–∞"""
        try:
            self.bot.answer_callback_query(call.id, "‚ùå –ü–æ—Å—Ç –æ—Ç–∫–ª–æ–Ω–µ–Ω!")
            
            try:
                status_text = f"\n\n<b>‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</b>"
                text_to_show = post_data.get('text', '') + status_text
                
                if 'image_url' in post_data and post_data['image_url']:
                    try:
                        self.bot.edit_message_caption(
                            chat_id=ADMIN_CHAT_ID,
                            message_id=message_id,
                            caption=text_to_show[:1020],
                            parse_mode='HTML',
                            reply_markup=None
                        )
                    except Exception as caption_error:
                        logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å caption: {caption_error}")
                        try:
                            self.bot.edit_message_text(
                                chat_id=ADMIN_CHAT_ID,
                                message_id=message_id,
                                text=text_to_show,
                                parse_mode='HTML',
                                reply_markup=None
                            )
                        except Exception as text_error:
                            logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: {text_error}")
                else:
                    self.bot.edit_message_text(
                        chat_id=ADMIN_CHAT_ID,
                        message_id=message_id,
                        text=text_to_show,
                        parse_mode='HTML',
                        reply_markup=None
                    )
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
            
            today = self.get_moscow_time().strftime("%Y-%m-%d")
            slot_time = post_data.get('slot_time', '')
            
            if slot_time:
                if "rejected_slots" not in self.post_history:
                    self.post_history["rejected_slots"] = {}
                
                if today not in self.post_history["rejected_slots"]:
                    self.post_history["rejected_slots"][today] = []
                
                self.post_history["rejected_slots"][today].append({
                    "time": slot_time,
                    "type": post_data.get('type'),
                    "theme": post_data.get('theme'),
                    "reason": "–û—Ç–∫–ª–æ–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É"
                })
                self._save_json("post_history.json", self.post_history)
            
            if message_id in self.pending_posts:
                del self.pending_posts[message_id]
                
            remaining = len([p for p in self.pending_posts.values() 
                           if p.get('status') in [PostStatus.PENDING, PostStatus.NEEDS_EDIT]])
            if remaining == 0:
                with self.completion_lock:
                    self.workflow_complete = True
                    
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è: {e}")
    
    def _handle_edit_request(self, message_id: int, post_data: Dict, call: CallbackQuery, edit_type: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"""
        try:
            self.bot.answer_callback_query(call.id, f"‚úèÔ∏è {edit_type}...")
            
            theme = post_data.get('theme', 'HR –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–æ–º')
            slot_style = post_data.get('slot_style', self.TIME_STYLES.get("15:00"))
            
            edit_timeout = self.get_moscow_time() + timedelta(minutes=10)
            post_data['edit_timeout'] = edit_timeout
            
            self.bot.send_message(
                chat_id=ADMIN_CHAT_ID,
                text=f"<b>‚úèÔ∏è –ó–∞–ø—Ä–æ—Å –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ '{edit_type}' –ø—Ä–∏–Ω—è—Ç.</b>\n"
                     f"<b>‚è∞ –í—Ä–µ–º—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ:</b> {edit_timeout.strftime('%H:%M')} –ú–°–ö",
                parse_mode='HTML'
            )
            
            if edit_type == "–ø–µ—Ä–µ–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç":
                new_text = self.regenerate_single_post(
                    post_data['type'],
                    theme,
                    slot_style,
                    f"–§–æ—Ç–æ –Ω–∞ —Ç–µ–º—É '{theme}'"
                )
                
                if new_text:
                    post_data['text'] = new_text
                    post_data['status'] = PostStatus.NEEDS_EDIT
                    
                    keyboard = self.create_inline_keyboard()
                    
                    if 'image_url' in post_data and post_data['image_url'] and post_data['image_url'].startswith('http'):
                        try:
                            self.bot.edit_message_caption(
                                chat_id=ADMIN_CHAT_ID,
                                message_id=message_id,
                                caption=new_text[:1024],
                                parse_mode='HTML',
                                reply_markup=keyboard
                            )
                        except:
                            self.bot.edit_message_text(
                                chat_id=ADMIN_CHAT_ID,
                                message_id=message_id,
                                text=new_text,
                                parse_mode='HTML',
                                reply_markup=keyboard
                            )
                    else:
                        self.bot.edit_message_text(
                            chat_id=ADMIN_CHAT_ID,
                            message_id=message_id,
                            text=new_text,
                            parse_mode='HTML',
                            reply_markup=keyboard
                        )
                    
                    self.bot.send_message(
                        chat_id=ADMIN_CHAT_ID,
                        text=f"‚úÖ –¢–µ–∫—Å—Ç {post_data['type']} –ø–æ—Å—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!",
                        parse_mode='HTML'
                    )
                else:
                    self.bot.send_message(
                        chat_id=ADMIN_CHAT_ID,
                        text=f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç {post_data['type']} –ø–æ—Å—Ç–∞",
                        parse_mode='HTML'
                    )
            
            elif edit_type == "–∑–∞–º–µ–Ω–∏ —Ñ–æ—Ç–æ":
                new_image_url, image_description = self.get_post_image_and_description(theme)
                
                if new_image_url and new_image_url.startswith('http'):
                    post_data['image_url'] = new_image_url
                    post_data['status'] = PostStatus.NEEDS_EDIT
                    
                    keyboard = self.create_inline_keyboard()
                    
                    try:
                        self.bot.delete_message(
                            chat_id=ADMIN_CHAT_ID,
                            message_id=message_id
                        )
                    except:
                        pass
                    
                    try:
                        sent = self.bot.send_photo(
                            chat_id=ADMIN_CHAT_ID,
                            photo=new_image_url,
                            caption=post_data['text'][:1024],
                            parse_mode='HTML',
                            reply_markup=keyboard
                        )
                        
                        old_data = self.pending_posts.pop(message_id, {})
                        self.pending_posts[sent.message_id] = {**old_data, 'image_url': new_image_url}
                        
                        self.bot.send_message(
                            chat_id=ADMIN_CHAT_ID,
                            text="‚úÖ –§–æ—Ç–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–º–µ–Ω–µ–Ω–æ!",
                            parse_mode='HTML'
                        )
                    except Exception as e:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ç–æ: {e}")
                        self.bot.send_message(
                            chat_id=ADMIN_CHAT_ID,
                            text=f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–º–µ–Ω—ã —Ñ–æ—Ç–æ: {e}",
                            parse_mode='HTML'
                        )
                else:
                    self.bot.send_message(
                        chat_id=ADMIN_CHAT_ID,
                        text="‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ",
                        parse_mode='HTML'
                    )
            
            elif edit_type == "–ø–µ—Ä–µ–¥–µ–ª–∞–π –ø–æ–ª–Ω–æ—Å—Ç—å—é":
                new_text = self.regenerate_single_post(
                    post_data['type'],
                    theme,
                    slot_style,
                    f"–§–æ—Ç–æ –Ω–∞ —Ç–µ–º—É '{theme}'"
                )
                
                new_image_url, image_description = self.get_post_image_and_description(theme)
                
                if new_text:
                    post_data['text'] = new_text
                    post_data['status'] = PostStatus.NEEDS_EDIT
                    
                    if new_image_url and new_image_url.startswith('http'):
                        post_data['image_url'] = new_image_url
                    
                    keyboard = self.create_inline_keyboard()
                    
                    try:
                        if new_image_url and new_image_url.startswith('http'):
                            self.bot.delete_message(
                                chat_id=ADMIN_CHAT_ID,
                                message_id=message_id
                            )
                            
                            sent = self.bot.send_photo(
                                chat_id=ADMIN_CHAT_ID,
                                photo=new_image_url,
                                caption=new_text[:1024],
                                parse_mode='HTML',
                                reply_markup=keyboard
                            )
                            
                            old_data = self.pending_posts.pop(message_id, {})
                            self.pending_posts[sent.message_id] = {**old_data, 'text': new_text, 'image_url': new_image_url}
                        else:
                            if 'image_url' in post_data and post_data['image_url'] and post_data['image_url'].startswith('http'):
                                self.bot.edit_message_caption(
                                    chat_id=ADMIN_CHAT_ID,
                                    message_id=message_id,
                                    caption=new_text[:1024],
                                    parse_mode='HTML',
                                    reply_markup=keyboard
                                )
                            else:
                                self.bot.edit_message_text(
                                    chat_id=ADMIN_CHAT_ID,
                                    message_id=message_id,
                                    text=new_text,
                                    parse_mode='HTML',
                                    reply_markup=keyboard
                                )
                        
                        self.bot.send_message(
                            chat_id=ADMIN_CHAT_ID,
                            text=f"‚úÖ {post_data['type']} –ø–æ—Å—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!",
                            parse_mode='HTML'
                        )
                    except Exception as e:
                        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
                        self.bot.send_message(
                            chat_id=ADMIN_CHAT_ID,
                            text=f"‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}",
                            parse_mode='HTML'
                        )
                else:
                    self.bot.send_message(
                        chat_id=ADMIN_CHAT_ID,
                        text=f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å {post_data['type']} –ø–æ—Å—Ç",
                        parse_mode='HTML'
                    )
            
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {e}")
            self.bot.send_message(
                chat_id=ADMIN_CHAT_ID,
                text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: {e}",
                parse_mode='HTML'
            )
    
    def _handle_new_post_request(self, message_id: int, post_data: Dict, call: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –Ω–æ–≤—ã–π –ø–æ—Å—Ç"""
        try:
            self.bot.answer_callback_query(call.id, "üéØ –í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É...")
            
            keyboard = InlineKeyboardMarkup(row_width=1)
            for theme in self.THEMES:
                keyboard.add(InlineKeyboardButton(
                    f"üéØ {theme}",
                    callback_data=f"theme_{theme}"
                ))
            keyboard.add(InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data="back_to_main"))
            
            try:
                caption = (f"<b>üéØ –í–´–ë–ï–†–ò–¢–ï –¢–ï–ú–£ –î–õ–Ø –ù–û–í–û–ì–û –ü–û–°–¢–ê</b>\n\n"
                          f"–¢–µ–∫—É—â–∞—è —Ç–µ–º–∞: {post_data.get('theme', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')}")
                
                if 'image_url' in post_data and post_data['image_url']:
                    self.bot.edit_message_caption(
                        chat_id=ADMIN_CHAT_ID,
                        message_id=message_id,
                        caption=caption,
                        parse_mode='HTML',
                        reply_markup=keyboard
                    )
                else:
                    self.bot.edit_message_text(
                        chat_id=ADMIN_CHAT_ID,
                        message_id=message_id,
                        text=caption,
                        parse_mode='HTML',
                        reply_markup=keyboard
                    )
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")
                
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –Ω–æ–≤—ã–π –ø–æ—Å—Ç: {e}")
    
    def _handle_theme_selection(self, message_id: int, post_data: Dict, call: CallbackQuery, callback_data: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã"""
        try:
            selected_theme = callback_data.replace("theme_", "")
            self.bot.answer_callback_query(call.id, f"‚úÖ –í—ã–±—Ä–∞–Ω–∞ —Ç–µ–º–∞: {selected_theme}")
            
            try:
                self.bot.delete_message(
                    chat_id=ADMIN_CHAT_ID,
                    message_id=message_id
                )
            except:
                pass
            
            self.bot.send_message(
                chat_id=ADMIN_CHAT_ID,
                text=f"<b>üîÑ –ì–ï–ù–ï–†–ò–†–£–Æ –ù–û–í–´–ô –ü–û–°–¢</b>\n\n"
                     f"<b>üéØ –¢–µ–º–∞:</b> {selected_theme}\n"
                     f"<b>‚è∞ –í—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:</b> {post_data.get('slot_time', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}\n"
                     f"<b>üì± –¢–∏–ø:</b> {post_data.get('type', '–ù–µ —É–∫–∞–∑–∞–Ω')}",
                parse_mode='HTML'
            )
            
            slot_style = post_data.get('slot_style', self.TIME_STYLES.get("15:00"))
            post_type = post_data.get('type', 'telegram')
            
            if post_type == 'telegram':
                prompt = self.create_telegram_prompt(selected_theme, slot_style, "—Ä–∞–∑–±–æ—Ä —Å–∏—Ç—É–∞—Ü–∏–∏", f"–§–æ—Ç–æ –Ω–∞ —Ç–µ–º—É '{selected_theme}'")
            else:
                prompt = self.create_zen_prompt(selected_theme, slot_style, "—Ä–∞–∑–±–æ—Ä —Å–∏—Ç—É–∞—Ü–∏–∏", f"–§–æ—Ç–æ –Ω–∞ —Ç–µ–º—É '{selected_theme}'")
            
            new_text = self.generate_with_gemini(prompt, post_type)
            
            if new_text:
                valid, fixed_text = self.validate_post_structure(new_text, post_type, slot_style if post_type == 'telegram' else None)
                
                if valid:
                    if self._is_duplicate_text(fixed_text):
                        self.bot.send_message(
                            chat_id=ADMIN_CHAT_ID,
                            text=f"‚ö†Ô∏è –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ–º—ã '{selected_theme}' –æ–∫–∞–∑–∞–ª—Å—è –¥—É–±–ª–∏–∫–∞—Ç–æ–º. –ü—Ä–æ–±—É—é —Å–Ω–æ–≤–∞...",
                            parse_mode='HTML'
                        )
                        for attempt in range(2):
                            new_text = self.generate_with_gemini(prompt, post_type)
                            if new_text:
                                valid, fixed_text = self.validate_post_structure(new_text, post_type, slot_style if post_type == 'telegram' else None)
                                if valid and not self._is_duplicate_text(fixed_text):
                                    break
                            time.sleep(2)
                    
                    new_image_url, image_description = self.get_post_image_and_description(selected_theme)
                    
                    keyboard = self.create_inline_keyboard()
                    
                    if new_image_url and new_image_url.startswith('http'):
                        sent = self.bot.send_photo(
                            chat_id=ADMIN_CHAT_ID,
                            photo=new_image_url,
                            caption=fixed_text[:1024],
                            parse_mode='HTML',
                            reply_markup=keyboard
                        )
                    else:
                        sent = self.bot.send_message(
                            chat_id=ADMIN_CHAT_ID,
                            text=fixed_text,
                            parse_mode='HTML',
                            reply_markup=keyboard
                        )
                    
                    self.pending_posts[sent.message_id] = {
                        'type': post_type,
                        'text': fixed_text,
                        'image_url': new_image_url or '',
                        'channel': post_data.get('channel', MAIN_CHANNEL if post_type == 'telegram' else ZEN_CHANNEL),
                        'status': PostStatus.PENDING,
                        'theme': selected_theme,
                        'slot_style': slot_style,
                        'slot_time': post_data.get('slot_time', ''),
                        'edit_timeout': self.get_moscow_time() + timedelta(minutes=10)
                    }
                    
                    self._add_to_generated_texts(fixed_text)
                    
                    self.bot.send_message(
                        chat_id=ADMIN_CHAT_ID,
                        text=f"‚úÖ –ù–æ–≤—ã–π {post_type} –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É '{selected_theme}' —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é!",
                        parse_mode='HTML'
                    )
                else:
                    self.bot.send_message(
                        chat_id=ADMIN_CHAT_ID,
                        text=f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–∞–ª–∏–¥–Ω—ã–π –ø–æ—Å—Ç –Ω–∞ —Ç–µ–º—É '{selected_theme}'",
                        parse_mode='HTML'
                    )
            else:
                self.bot.send_message(
                    chat_id=ADMIN_CHAT_ID,
                    text=f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ–º—ã '{selected_theme}'",
                    parse_mode='HTML'
                )
            
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã: {e}")
            self.bot.send_message(
                chat_id=ADMIN_CHAT_ID,
                text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ—Å—Ç–∞: {e}",
                parse_mode='HTML'
            )
    
    def _handle_back_to_main(self, message_id: int, post_data: Dict, call: CallbackQuery):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∫ –æ—Å–Ω–æ–≤–Ω—ã–º –∫–Ω–æ–ø–∫–∞–º"""
        try:
            self.bot.answer_callback_query(call.id, "‚¨ÖÔ∏è –í–æ–∑–≤—Ä–∞—Ç")
            self._restore_main_buttons(message_id, post_data)
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞: {e}")
    
    def _restore_main_buttons(self, message_id: int, post_data: Dict):
        """–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏"""
        try:
            keyboard = self.create_inline_keyboard()
            
            if 'image_url' in post_data and post_data['image_url'] and post_data.get('text'):
                try:
                    self.bot.edit_message_caption(
                        chat_id=ADMIN_CHAT_ID,
                        message_id=message_id,
                        caption=post_data['text'][:1024],
                        parse_mode='HTML',
                        reply_markup=keyboard
                    )
                except Exception as caption_error:
                    logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å caption: {caption_error}")
                    try:
                        self.bot.edit_message_text(
                            chat_id=ADMIN_CHAT_ID,
                            message_id=message_id,
                            text=post_data['text'],
                            parse_mode='HTML',
                            reply_markup=keyboard
                        )
                    except Exception as text_error:
                        logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: {text_error}")
            elif post_data.get('text'):
                self.bot.edit_message_text(
                    chat_id=ADMIN_CHAT_ID,
                    message_id=message_id,
                    text=post_data['text'],
                    parse_mode='HTML',
                    reply_markup=keyboard
                )
                
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏: {e}")
    
    # ========== –û–°–ù–û–í–ù–´–ï –ú–ï–¢–û–î–´ ==========
    def _is_admin_message(self, message: Message) -> bool:
        return str(message.chat.id) == ADMIN_CHAT_ID
    
    def _get_slot_for_time(self, target_time: datetime, auto: bool = False) -> Tuple[Optional[str], Optional[Dict]]:
        try:
            hour, minute = target_time.hour, target_time.minute
            
            if auto:
                today = self.get_moscow_time().strftime("%Y-%m-%d")
                sent_slots_today = self.post_history.get("sent_slots", {}).get(today, [])
                rejected_slots_today = self.post_history.get("rejected_slots", {}).get(today, [])
                
                for slot_time, slot_style in self.TIME_STYLES.items():
                    slot_hour, slot_minute = map(int, slot_time.split(':'))
                    slot_datetime = datetime(target_time.year, target_time.month, target_time.day, slot_hour, slot_minute)
                    
                    if target_time >= slot_datetime:
                        if slot_time not in sent_slots_today and slot_time not in rejected_slots_today:
                            has_pending_for_slot = any(
                                post.get('slot_time') == slot_time and 
                                post.get('status') in [PostStatus.PENDING, PostStatus.NEEDS_EDIT]
                                for post in self.pending_posts.values()
                            )
                            
                            if not has_pending_for_slot:
                                logger.info(f"üïí –ù–∞–π–¥–µ–Ω –Ω–µ–∑–∞–ø—É—â–µ–Ω–Ω—ã–π —Å–ª–æ—Ç {slot_time} –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–ø—É—Å–∫–∞")
                                return slot_time, slot_style
                
                logger.info("‚è∞ –í—Å–µ —Å–ª–æ—Ç—ã –Ω–∞ —Å–µ–≥–æ–¥–Ω—è —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –∏–ª–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–∂–∏–¥–∞–Ω–∏–∏")
                return None, None
            
            if hour >= 20 or hour < 4:
                return "20:00", self.TIME_STYLES.get("20:00")
            
            if hour >= 4 and hour < 11:
                return "11:00", self.TIME_STYLES.get("11:00")
            
            current_minutes = hour * 60 + minute
            
            if auto:
                for slot_time, slot_style in self.TIME_STYLES.items():
                    slot_hour, slot_minute = map(int, slot_time.split(':'))
                    slot_minutes = slot_hour * 60 + slot_minute
                    
                    if abs(current_minutes - slot_minutes) <= 10:
                        return slot_time, slot_style
                return None, None
            
            future_slots = []
            for slot_time in self.TIME_STYLES.keys():
                slot_hour, slot_minute = map(int, slot_time.split(':'))
                slot_minutes = slot_hour * 60 + slot_minute
                
                if slot_minutes > current_minutes:
                    future_slots.append((slot_time, slot_minutes))
            
            if future_slots:
                future_slots.sort(key=lambda x: x[1])
                slot_time = future_slots[0][0]
                return slot_time, self.TIME_STYLES.get(slot_time)
            
            return "11:00", self.TIME_STYLES.get("11:00")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–ª–æ—Ç–∞: {e}")
            return None, None
    
    def _get_smart_theme(self) -> str:
        try:
            theme_rotation = self.post_history.get("theme_rotation", [])
            
            if len(theme_rotation) >= 2:
                last_two = theme_rotation[-2:]
                
                if last_two[0] == last_two[1]:
                    available_themes = [theme for theme in self.THEMES if theme != last_two[1]]
                    self.current_theme = random.choice(available_themes) if available_themes else self.THEMES[0]
                else:
                    available_themes = [theme for theme in self.THEMES if theme != last_two[1]]
                    self.current_theme = random.choice(available_themes) if available_themes else self.THEMES[0]
            elif len(theme_rotation) == 1:
                last_theme = theme_rotation[-1]
                available_themes = [theme for theme in self.THEMES if theme != last_theme]
                self.current_theme = random.choice(available_themes) if available_themes else self.THEMES[0]
            else:
                self.current_theme = random.choice(self.THEMES)
            
            return self.current_theme
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Ç–µ–º—ã: {e}")
            self.current_theme = random.choice(self.THEMES)
            return self.current_theme
    
    def _publish_to_channel(self, text: str, image_url: str, channel: str) -> bool:
        try:
            logger.info(f"üì§ –ü—É–±–ª–∏–∫—É—é –≤ {channel}")
            
            if image_url and image_url.strip() and image_url.startswith('http'):
                try:
                    caption = text[:1024] if len(text) > 1024 else text
                    self.bot.send_photo(
                        chat_id=channel,
                        photo=image_url,
                        caption=caption,
                        parse_mode='HTML'
                    )
                    if len(text) > 1024:
                        self.bot.send_message(
                            chat_id=channel,
                            text=text[1024:],
                            parse_mode='HTML'
                        )
                except Exception as photo_error:
                    logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π: {photo_error}")
                    self.bot.send_message(
                        chat_id=channel,
                        text=text,
                        parse_mode='HTML'
                    )
            else:
                self.bot.send_message(
                    chat_id=channel,
                    text=text,
                    parse_mode='HTML'
                )
            
            logger.info(f"‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ {channel}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ {channel}: {e}")
            return False
    
    def send_to_admin_for_moderation(self, slot_time: str, tg_text: str, zen_text: str, 
                                    image_url: str, theme: str) -> int:
        logger.info("üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é –ø–æ—Å—Ç—ã –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é...")
        
        success_count = 0
        edit_timeout = self.get_moscow_time() + timedelta(minutes=10)
        
        def send_post(post_type: str, text: str, channel: str) -> Optional[int]:
            nonlocal success_count
            try:
                keyboard = self.create_inline_keyboard()
                caption_length = 1024
                
                if image_url and image_url.strip() and image_url.startswith('http'):
                    for attempt in range(3):
                        try:
                            caption = text[:caption_length]
                            sent = self.bot.send_photo(
                                chat_id=ADMIN_CHAT_ID,
                                photo=image_url,
                                caption=caption,
                                parse_mode='HTML',
                                reply_markup=keyboard
                            )
                            message_id = sent.message_id
                            break
                        except Exception as photo_error:
                            if attempt == 2:
                                logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ 3 –ø–æ–ø—ã—Ç–æ–∫: {photo_error}")
                                sent = self.bot.send_message(
                                    chat_id=ADMIN_CHAT_ID,
                                    text=text,
                                    parse_mode='HTML',
                                    reply_markup=keyboard
                                )
                                message_id = sent.message_id
                                image_url_used = ''
                            else:
                                time.sleep(1)
                                continue
                else:
                    sent = self.bot.send_message(
                        chat_id=ADMIN_CHAT_ID,
                        text=text,
                        parse_mode='HTML',
                        reply_markup=keyboard
                    )
                    message_id = sent.message_id
                    image_url_used = ''
                
                self.pending_posts[message_id] = {
                    'type': post_type,
                    'text': text,
                    'image_url': image_url_used if 'image_url_used' in locals() else image_url,
                    'channel': channel,
                    'status': PostStatus.PENDING,
                    'theme': theme,
                    'slot_style': self.current_style,
                    'slot_time': slot_time,
                    'edit_timeout': edit_timeout
                }
                
                success_count += 1
                return message_id
                
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ {post_type} –ø–æ—Å—Ç–∞: {e}")
                return None
        
        tg_message_id = None
        zen_message_id = None
        
        if tg_text and tg_text.strip():
            tg_message_id = send_post('telegram', tg_text, MAIN_CHANNEL)
            if tg_message_id:
                time.sleep(1)
        else:
            logger.error("‚ùå –ù–µ –º–æ–≥—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å Telegram –ø–æ—Å—Ç –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—Å—Ç")
            return 0
        
        if zen_text and zen_text.strip():
            zen_message_id = send_post('zen', zen_text, ZEN_CHANNEL)
            if zen_message_id:
                time.sleep(1)
        else:
            logger.error("‚ùå –ù–µ –º–æ–≥—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å Zen –ø–æ—Å—Ç –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—Å—Ç")
            return 0
        
        if tg_message_id or zen_message_id:
            try:
                tg_token_min, tg_token_max = self.current_style['tg_tokens']
                zen_token_min, zen_token_max = self.current_style['zen_tokens']
                total_token_min, total_token_max = self.current_style['total_tokens']
                
                instruction = (f"<b>‚úÖ –ü–û–°–¢–´ –û–¢–ü–†–ê–í–õ–ï–ù–´ –ù–ê –ú–û–î–ï–†–ê–¶–ò–Æ</b>\n\n")
                
                if tg_text:
                    instruction += (f"<b>üì± Telegram –ø–æ—Å—Ç</b>\n"
                                  f"   –ö–∞–Ω–∞–ª: {MAIN_CHANNEL}\n"
                                  f"   –í—Ä–µ–º—è: {slot_time} –ú–°–ö\n"
                                  f"   –°–∏–º–≤–æ–ª–æ–≤: {len(tg_text)} (–Ω—É–∂–Ω–æ {self.current_style['tg_chars'][0]}-{self.current_style['tg_chars'][1]})\n"
                                  f"   –¢–æ–∫–µ–Ω–æ–≤: {tg_token_min}-{tg_token_max}\n\n")
                
                if zen_text:
                    instruction += (f"<b>üìù –î–∑–µ–Ω –ø–æ—Å—Ç</b>\n"
                                  f"   –ö–∞–Ω–∞–ª: {ZEN_CHANNEL}\n"
                                  f"   –í—Ä–µ–º—è: {slot_time} –ú–°–ö\n"
                                  f"   –°–∏–º–≤–æ–ª–æ–≤: {len(zen_text)} (–Ω—É–∂–Ω–æ {self.current_style['zen_chars'][0]}-{self.current_style['zen_chars'][1]})\n"
                                  f"   –¢–æ–∫–µ–Ω–æ–≤: {zen_token_min}-{zen_token_max}\n\n")
                
                instruction += (f"<b>üìä –ò—Ç–æ–≥ –ø–æ —Ç–æ–∫–µ–Ω–∞–º:</b> {total_token_min}-{total_token_max} —Ç–æ–∫–µ–Ω–æ–≤\n\n"
                              f"<b>‚è∞ –í—Ä–µ–º—è –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ:</b> –¥–æ {edit_timeout.strftime('%H:%M')} –ú–°–ö")
                
                self.bot.send_message(
                    chat_id=ADMIN_CHAT_ID,
                    text=instruction,
                    parse_mode='HTML'
                )
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: {e}")
        
        return success_count
    
    def create_and_send_posts(self, slot_time: str, slot_style: Dict) -> bool:
        try:
            logger.info(f"üé¨ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ–≤ –¥–ª—è {slot_time}")
            self.current_style = slot_style
            
            theme = self._get_smart_theme()
            text_format = "—Ä–∞–∑–±–æ—Ä —Å–∏—Ç—É–∞—Ü–∏–∏"
            
            image_url, image_description = self.get_post_image_and_description(theme)
            
            tg_text, zen_text = self.generate_with_retry(theme, slot_style, text_format, image_description)
            
            if not tg_text:
                logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å Telegram –ø–æ—Å—Ç")
                self.bot.send_message(
                    chat_id=ADMIN_CHAT_ID,
                    text=f"‚ùå <b>–ù–ï–£–î–ê–ß–ê –ì–ï–ù–ï–†–ê–¶–ò–ò</b>\n\n"
                         f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Telegram –ø–æ—Å—Ç –¥–ª—è —Å–ª–æ—Ç–∞ {slot_time}\n"
                         f"–¢–µ–º–∞: {theme}",
                    parse_mode='HTML'
                )
                return False
            
            success_count = self.send_to_admin_for_moderation(
                slot_time, 
                tg_text, 
                zen_text, 
                image_url, 
                theme
            )
            
            if success_count >= 2:
                today = self.get_moscow_time().strftime("%Y-%m-%d")
                if "sent_slots" not in self.post_history:
                    self.post_history["sent_slots"] = {}
                if today not in self.post_history["sent_slots"]:
                    self.post_history["sent_slots"][today] = []
                
                self.post_history["sent_slots"][today].append(slot_time)
                
                if "theme_rotation" not in self.post_history:
                    self.post_history["theme_rotation"] = []
                self.post_history["theme_rotation"].append(theme)
                
                self._save_json("post_history.json", self.post_history)
                
                logger.info(f"‚úÖ {success_count} –ø–æ—Å—Ç–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é")
                return True
            else:
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±–∞ –ø–æ—Å—Ç–∞ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é (–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {success_count})")
                return False
            
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Å—Ç–æ–≤: {e}")
            self.bot.send_message(
                chat_id=ADMIN_CHAT_ID,
                text=f"‚ùå <b>–û–®–ò–ë–ö–ê –ü–†–ò –°–û–ó–î–ê–ù–ò–ò –ü–û–°–¢–û–í</b>\n\n"
                     f"–°–ª–æ—Ç: {slot_time}\n"
                     f"–û—à–∏–±–∫–∞: {str(e)[:200]}...",
                parse_mode='HTML'
            )
            return False
    
    def run_single_cycle(self):
        try:
            logger.info("üöÄ –ó–∞–ø—É—Å–∫ –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–≥–æ —Ü–∏–∫–ª–∞")
            
            now = self.get_moscow_time()
            if self.target_slot:
                slot_style = self.TIME_STYLES.get(self.target_slot)
                if not slot_style:
                    logger.error(f"‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Å–ª–æ—Ç: {self.target_slot}")
                    return
                slot_time = self.target_slot
            else:
                slot_time, slot_style = self._get_slot_for_time(now, self.auto)
                if not slot_time or not slot_style:
                    logger.info("‚è∞ –ù–µ –≤—Ä–µ–º—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏")
                    return
            
            success = self.create_and_send_posts(slot_time, slot_style)
            
            if not success:
                logger.error("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç—ã")
                return
            
            self.bot.delete_webhook(drop_pending_updates=True)
            
            @self.bot.callback_query_handler(func=lambda call: True)
            def handle_callback(call):
                self._handle_callback(call)
            
            def polling_task():
                try:
                    while not self.stop_polling:
                        try:
                            self.bot.polling(none_stop=True, interval=1, timeout=30)
                        except Exception as e:
                            logger.error(f"‚ùå –û—à–∏–±–∫–∞ polling: {e}")
                            time.sleep(5)
                except Exception as e:
                    logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ polling: {e}")
            
            self.polling_thread = threading.Thread(target=polling_task, daemon=True)
            self.polling_thread.start()
            
            logger.info("‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (10 –º–∏–Ω—É—Ç)...")
            start_time = time.time()
            timeout = 600
            
            while time.time() - start_time < timeout:
                with self.completion_lock:
                    if self.workflow_complete:
                        logger.info("‚úÖ Workflow –∑–∞–≤–µ—Ä—à–µ–Ω")
                        break
                
                remaining = len([p for p in self.pending_posts.values() 
                               if p.get('status') in [PostStatus.PENDING, PostStatus.NEEDS_EDIT]])
                if remaining == 0:
                    logger.info("‚úÖ –í—Å–µ –ø–æ—Å—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã")
                    break
                
                time.sleep(1)
            
            logger.info("üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é polling...")
            self.stop_polling = True
            
            if self.polling_thread and self.polling_thread.is_alive():
                self.polling_thread.join(timeout=5)
            
            logger.info("‚úÖ –†–∞–±–æ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
            
        except Exception as e:
            logger.error(f"üí• –û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ —Ä–∞–±–æ—Ç—ã: {e}")


def main():
    try:
        parser = argparse.ArgumentParser()
        parser.add_argument('--slot', help='–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ª–æ—Ç (—Ñ–æ—Ä–º–∞—Ç HH:MM)')
        parser.add_argument('--auto', action='store_true', help='–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫')
        
        args = parser.parse_args()
        
        bot = TelegramBot(target_slot=args.slot, auto=args.auto)
        bot.run_single_cycle()
        
    except KeyboardInterrupt:
        logger.info("üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    except Exception as e:
        logger.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")


if __name__ == "__main__":
    main()
