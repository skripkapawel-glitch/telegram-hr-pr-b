name: Telegram Webhook Handler

on:
  repository_dispatch:
    types: [telegram_callback]

jobs:
  handle-webhook:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: üì¶ Install dependencies
        run: |
          pip install requests==2.31.0
          
      - name: üîÑ Pull latest changes
        run: |
          git pull origin main || true
          
      - name: ü§ñ Handle Webhook
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        run: |
          echo "üîß –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–∞..."
          
          # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–µ–±—Ö—É–∫–∞
          WEBHOOK_DATA='${{ toJSON(github.event.client_payload) }}'
          
          echo "üìä –î–∞–Ω–Ω—ã–µ –≤–µ–±—Ö—É–∫–∞ –ø–æ–ª—É—á–µ–Ω—ã"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
          python -c "
import os
import json
import sys

sys.path.append('.')

# –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
webhook_data = '''$WEBHOOK_DATA'''
print(f'üì¶ –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö: {type(webhook_data)}')
print(f'üì¶ –î–ª–∏–Ω–∞: {len(webhook_data)}')

# –ü–∞—Ä—Å–∏–º JSON
try:
    if isinstance(webhook_data, str) and webhook_data.strip():
        data = json.loads(webhook_data)
    else:
        data = webhook_data
    
    print(f'üìä –¢–∏–ø –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞: {type(data)}')
    print(f'üìä –ö–ª—é—á–∏ –≤ –¥–∞–Ω–Ω—ã—Ö: {list(data.keys())}')
    
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    try:
        from approval_bot import process_callback
        print('‚úÖ –ú–æ–¥—É–ª—å approval_bot –∑–∞–≥—Ä—É–∂–µ–Ω')
    except Exception as e:
        print(f'‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è approval_bot: {e}')
        import traceback
        traceback.print_exc()
        exit(1)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º callback query
    if 'callback_query' in data:
        callback = data['callback_query']
        callback_data = callback.get('data', '')
        callback_id = callback.get('id', '')
        
        print(f'üéØ –ù–∞–π–¥–µ–Ω callback_query!')
        print(f'   Data: {callback_data}')
        print(f'   ID: {callback_id}')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –î–û –æ–±—Ä–∞–±–æ—Ç–∫–∏
        import glob
        pending_files = glob.glob('pending_*.json')
        print(f'üìÅ Pending —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π: {len(pending_files)}')
        
        if pending_files:
            for file in pending_files:
                try:
                    with open(file, 'r', encoding='utf-8') as f:
                        post_data = json.load(f)
                    print(f'   ‚Ä¢ {file}: {post_data.get(\"theme\")}')
                except:
                    print(f'   ‚Ä¢ {file}: –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è')
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º callback
        if callback_data:
            success = process_callback(callback_data, callback_id)
            print(f'üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏: {'‚úÖ –£—Å–ø–µ—à–Ω–æ' if success else '‚ùå –û—à–∏–±–∫–∞'}')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –ü–û–°–õ–ï –æ–±—Ä–∞–±–æ—Ç–∫–∏
            pending_after = glob.glob('pending_*.json')
            published = glob.glob('published_*.json')
            print(f'üìä –ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏:')
            print(f'   Pending —Ñ–∞–π–ª–æ–≤: {len(pending_after)}')
            print(f'   Published —Ñ–∞–π–ª–æ–≤: {len(published)}')
            
            if published:
                for file in published:
                    print(f'   üìÑ {file}')
        
        else:
            print('‚ùå Callback data –ø—É—Å—Ç–æ–π')
            
    else:
        print('‚ö†Ô∏è –ù–µ callback_query, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º')
        
except json.JSONDecodeError as e:
    print(f'‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {e}')
    print(f'üìÑ –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ: {webhook_data[:200]}...')
except Exception as e:
    print(f'üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}')
    import traceback
    traceback.print_exc()

print('‚úÖ –í–µ–±—Ö—É–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω')
          "
          
      - name: üíæ Commit and push results
        if: always()
        run: |
          echo "üíæ –°–æ—Ö—Ä–∞–Ω—è—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã..."
          
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add -A
          
          if git diff --cached --quiet; then
            echo "üì≠ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          else
            echo "üìù –ï—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ–º–º–∏—Ç–∏–º..."
            git commit -m "Webhook processing [skip ci]"
            git push
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"
          fi
