name: Telegram Webhook Handler

on:
  repository_dispatch:
    types: [telegram_webhook]

jobs:
  handle-webhook:
    runs-on: ubuntu-latest
    
    timeout-minutes: 5
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: üì¶ Install dependencies
        run: |
          pip install requests==2.31.0
          
      - name: ü§ñ Handle Webhook
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        run: |
          echo "üîß –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–µ–±—Ö—É–∫–∞..."
          
          # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–µ–±—Ö—É–∫–∞
          WEBHOOK_DATA='${{ toJSON(github.event.client_payload) }}'
          
          echo "üìä –î–∞–Ω–Ω—ã–µ –≤–µ–±—Ö—É–∫–∞:"
          echo "$WEBHOOK_DATA" | python -m json.tool || echo "$WEBHOOK_DATA"
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
          python -c "
import json
import sys
sys.path.append('.')
from webhook_handler import handle_webhook

data = json.loads('''$WEBHOOK_DATA''')
result = handle_webhook(data)
print('üì§ –†–µ–∑—É–ª—å—Ç–∞—Ç:', json.dumps(result, indent=2))
          "
          
          echo "‚úÖ –í–µ–±—Ö—É–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω"
