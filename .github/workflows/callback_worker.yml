name: Telegram Callback Worker

on:
  schedule:
    - cron: '*/2 * * * *'  # –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
  workflow_dispatch:

jobs:
  process-callbacks:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: üì¶ Install dependencies
        run: pip install requests==2.31.0
          
      - name: ü§ñ Process Telegram Callbacks
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          echo "ü§ñ –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–∞–∂–∞—Ç—ã—Ö –∫–Ω–æ–ø–æ–∫..."
          echo "========================================"
          
          python -c "
import requests
import os
import sys

BOT_TOKEN = os.environ.get('BOT_TOKEN')

if not BOT_TOKEN:
    print('‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')
    exit(1)

# –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å
sys.path.append('.')
try:
    from approval_bot import process_callback
    print('‚úÖ –ú–æ–¥—É–ª—å approval_bot –∑–∞–≥—Ä—É–∂–µ–Ω')
except Exception as e:
    print(f'‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è: {e}')
    exit(1)

# –ß–∏—Ç–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π offset
try:
    with open('last_offset.txt', 'r') as f:
        offset = int(f.read().strip())
    print(f'üìä –ù–∞—á–∏–Ω–∞–µ–º —Å offset: {offset}')
except:
    offset = 0
    print(f'üìä –§–∞–π–ª offset –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º —Å 0')

# –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
try:
    response = requests.get(
        f'https://api.telegram.org/bot{BOT_TOKEN}/getUpdates',
        params={'offset': offset, 'timeout': 20},
        timeout=30
    )
    
    if response.status_code == 200:
        data = response.json()
        
        if data.get('ok') and data.get('result'):
            updates = data['result']
            print(f'üì® –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {len(updates)}')
            
            for update in updates:
                offset = update['update_id'] + 1
                
                if 'callback_query' in update:
                    callback = update['callback_query']
                    callback_data = callback.get('data', '')
                    callback_id = callback.get('id', '')
                    
                    print(f'üîî –ù–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞: {callback_data}')
                    print(f'üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º...')
                    
                    success = process_callback(callback_data, callback_id)
                    
                    if success:
                        print(f'‚úÖ –ö–Ω–æ–ø–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!')
                    else:
                        print(f'‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏')
                else:
                    print(f'üì≠ –ù–µ callback (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º)')
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π offset
            with open('last_offset.txt', 'w') as f:
                f.write(str(offset))
            print(f'üíæ Offset —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {offset}')
        else:
            print('üì≠ –ù–µ—Ç –Ω–æ–≤—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π')
    else:
        print(f'‚ùå –û—à–∏–±–∫–∞ API: {response.status_code}')
        
except Exception as e:
    print(f'‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {e}')

print('========================================')
"

      - name: üíæ Commit offset changes
        run: |
          if [ -f last_offset.txt ]; then
            git config --global user.name 'GitHub Actions'
            git config --global user.email 'actions@github.com'
            git add last_offset.txt
            git commit -m "Update callback offset [skip ci]" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π"
            git push || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è push"
          fi
