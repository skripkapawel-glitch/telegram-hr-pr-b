name: Handle Telegram Callbacks

on:
  schedule:
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
    - cron: '*/2 * * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: '–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞'
        required: false

jobs:
  process-callbacks:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: üì¶ Install dependencies
        run: |
          pip install requests==2.31.0
          
      - name: üìÑ Check existing files
        run: |
          echo "üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–æ–≤..."
          echo "=" * 50
          ls -la *.json *.txt 2>/dev/null || echo "–§–∞–π–ª–æ–≤ –Ω–µ—Ç"
          echo "=" * 50
          
      - name: ü§ñ Process Telegram Callbacks
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          ADMIN_CHAT_ID: ${{ secrets.ADMIN_CHAT_ID }}
          CHANNEL_ID: ${{ secrets.CHANNEL_ID }}
        run: |
          echo "üîÑ –ó–ê–ü–£–°–ö –û–ë–†–ê–ë–û–¢–ö–ò CALLBACK-–û–í"
          echo "=" * 60
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
          if [ -z "$BOT_TOKEN" ]; then
            echo "‚ùå –û–®–ò–ë–ö–ê: BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
            exit 1
          fi
          
          echo "‚úÖ BOT_TOKEN: —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
          echo "‚úÖ ADMIN_CHAT_ID: $ADMIN_CHAT_ID"
          echo "‚úÖ CHANNEL_ID: $CHANNEL_ID"
          
          # –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏
          python -c "
import os
import requests
import json
import sys
import logging
import time

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

BOT_TOKEN = os.environ.get('BOT_TOKEN')
ADMIN_CHAT_ID = os.environ.get('ADMIN_CHAT_ID')
CHANNEL_ID = os.environ.get('CHANNEL_ID')

print(f'üîë BOT_TOKEN: {'***' + BOT_TOKEN[-5:] if BOT_TOKEN else '–ù–ï–¢'}')
print(f'üë§ ADMIN_CHAT_ID: {ADMIN_CHAT_ID}')
print(f'üì¢ CHANNEL_ID: {CHANNEL_ID}')

if not BOT_TOKEN:
    print('‚ùå BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω')
    sys.exit(1)

# –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥—É–ª—å –æ–±—Ä–∞–±–æ—Ç–∫–∏
sys.path.append('.')
try:
    from approval_bot import process_callback
    print('‚úÖ –ú–æ–¥—É–ª—å approval_bot –∑–∞–≥—Ä—É–∂–µ–Ω')
except Exception as e:
    print(f'‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è approval_bot: {e}')
    import traceback
    traceback.print_exc()
    sys.exit(1)

def load_offset():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π offset"""
    try:
        with open('last_offset.txt', 'r') as f:
            offset = int(f.read().strip())
        print(f'üìä Offset –∏–∑ —Ñ–∞–π–ª–∞: {offset}')
        return offset
    except Exception as e:
        print(f'üìä –§–∞–π–ª offset –Ω–µ –Ω–∞–π–¥–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º —Å 0')
        return 0

def save_offset(offset):
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç offset"""
    try:
        with open('last_offset.txt', 'w') as f:
            f.write(str(offset))
        print(f'üíæ Offset —Å–æ—Ö—Ä–∞–Ω–µ–Ω: {offset}')
    except Exception as e:
        print(f'‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å offset: {e}')

def get_updates(offset):
    """–ü–æ–ª—É—á–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç Telegram"""
    try:
        print(f'üì® –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å offset={offset}...')
        
        response = requests.get(
            f'https://api.telegram.org/bot{BOT_TOKEN}/getUpdates',
            params={
                'offset': offset,
                'timeout': 10,
                'allowed_updates': ['callback_query']
            },
            timeout=15
        )
        
        print(f'üì® –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞: {response.status_code}')
        
        if response.status_code == 200:
            return response.json()
        else:
            print(f'‚ùå –û—à–∏–±–∫–∞ API: {response.status_code}')
            print(f'üìÑ –û—Ç–≤–µ—Ç: {response.text[:200]}')
            return None
            
    except Exception as e:
        print(f'‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {e}')
        return None

def answer_callback_query(callback_id):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –ø–æ–ª—É—á–µ–Ω–∏–µ callback"""
    try:
        response = requests.post(
            f'https://api.telegram.org/bot{BOT_TOKEN}/answerCallbackQuery',
            params={'callback_query_id': callback_id},
            timeout=5
        )
        if response.status_code == 200:
            print(f'üì§ –û—Ç–≤–µ—Ç –Ω–∞ callback –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω')
        else:
            print(f'‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ callback')
    except Exception as e:
        print(f'‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ callback: {e}')

def check_pending_files():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ pending —Ñ–∞–π–ª–æ–≤"""
    import glob
    pending_files = glob.glob('pending_*.json')
    if pending_files:
        print(f'üìÅ –ù–∞–π–¥–µ–Ω–æ pending —Ñ–∞–π–ª–æ–≤: {len(pending_files)}')
        for file in pending_files:
            try:
                with open(file, 'r', encoding='utf-8') as f:
                    data = json.load(f)
                print(f'   ‚Ä¢ {file}: {data.get(\"theme\", \"–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ\")}')
            except:
                print(f'   ‚Ä¢ {file}: –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è')
    else:
        print('üì≠ –ù–µ—Ç pending —Ñ–∞–π–ª–æ–≤')
    return pending_files

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
try:
    print('')
    print('üîç –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í:')
    print('=' * 40)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º pending —Ñ–∞–π–ª—ã
    pending_files = check_pending_files()
    
    print('')
    print('üîÑ –û–ë–†–ê–ë–û–¢–ö–ê –û–ë–ù–û–í–õ–ï–ù–ò–ô:')
    print('=' * 40)
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º offset
    offset = load_offset()
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    data = get_updates(offset)
    
    if data and data.get('ok'):
        updates = data.get('result', [])
        print(f'üì® –ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π: {len(updates)}')
        
        if updates:
            print('')
            print('üìã –î–ï–¢–ê–õ–ò –û–ë–ù–û–í–õ–ï–ù–ò–ô:')
            print('-' * 30)
            
            for i, update in enumerate(updates):
                print(f'–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ #{i+1}:')
                print(f'  ID: {update.get(\"update_id\")}')
                
                if 'callback_query' in update:
                    callback = update['callback_query']
                    callback_data = callback.get('data', '')
                    callback_id = callback.get('id', '')
                    
                    print(f'  ‚úÖ –ù–ê–ô–î–ï–ù CALLBACK!')
                    print(f'    Data: {callback_data}')
                    print(f'    ID: {callback_id}')
                    print(f'    –û—Ç: {callback.get(\"from\", {}).get(\"id\")}')
                    
                    if callback_data:
                        print(f'    üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...')
                        
                        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º callback
                        success = process_callback(callback_data, callback_id)
                        
                        if success:
                            print(f'    ‚úÖ –£–°–ü–ï–®–ù–û –û–ë–†–ê–ë–û–¢–ê–ù–û!')
                        else:
                            print(f'    ‚ùå –û–®–ò–ë–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò')
                        
                        # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ
                        answer_callback_query(callback_id)
                        print(f'    üì§ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram')
                    
                    print(f'    üìù –°—Ç–∞—Ä—ã–π offset: {offset}')
                    new_offset = update['update_id'] + 1
                    offset = new_offset
                    print(f'    üìù –ù–æ–≤—ã–π offset: {offset}')
                    
                else:
                    print(f'  üì≠ –ù–µ callback (–ø—Ä–æ–ø—É—Å–∫–∞–µ–º)')
                    new_offset = update['update_id'] + 1
                    offset = new_offset
                
                print('')
            
            print(f'üìä –ò—Ç–æ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ callback-–æ–≤: {len([u for u in updates if \"callback_query\" in u])}')
        else:
            print('üì≠ –ù–µ—Ç –Ω–æ–≤—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π')
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º offset
        save_offset(offset)
        
    else:
        print('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram')
        if data:
            print(f'üìä –î–∞–Ω–Ω—ã–µ: {json.dumps(data, indent=2)[:500]}')
    
    print('')
    print('‚úÖ –û–ë–†–ê–ë–û–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê')
    print('=' * 40)
    
except Exception as e:
    print(f'üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}')
    import traceback
    traceback.print_exc()
    sys.exit(1)

print('')
print('üîç –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:')
print('=' * 40)

# –ü—Ä–æ–≤–µ—Ä—è–µ–º published —Ñ–∞–π–ª—ã
import glob
published_files = glob.glob('published_*.json')
if published_files:
    print(f'‚úÖ Published —Ñ–∞–π–ª–æ–≤: {len(published_files)}')
    for file in published_files:
        print(f'   üìÑ {file}')
else:
    print('üì≠ –ù–µ—Ç published —Ñ–∞–π–ª–æ–≤')

print('=' * 40)
print('üèÅ –†–ê–ë–û–¢–ê –ó–ê–í–ï–†–®–ï–ù–ê')
"

          echo ""
          echo "=" * 60
          echo "‚úÖ –û–ë–†–ê–ë–û–¢–ö–ê CALLBACK-–û–í –ó–ê–í–ï–†–®–ï–ù–ê"
          echo "=" * 60
          
      - name: üìä Show Summary
        if: always()
        run: |
          echo "üìã –°–í–û–î–ö–ê –ü–û –§–ê–ô–õ–ê–ú:"
          echo "=" * 50
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Ñ–∞–π–ª–æ–≤
          echo "üìÅ Pending —Ñ–∞–π–ª—ã:"
          ls -1 pending_*.json 2>/dev/null | wc -l | xargs echo "   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:"
          ls -1 pending_*.json 2>/dev/null | head -5 | while read file; do
            echo "   ‚Ä¢ $file"
          done
          
          echo ""
          echo "‚úÖ Published —Ñ–∞–π–ª—ã:"
          ls -1 published_*.json 2>/dev/null | wc -l | xargs echo "   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:"
          ls -1 published_*.json 2>/dev/null | head -5 | while read file; do
            echo "   ‚Ä¢ $file"
          done
          
          echo ""
          echo "üìä Status —Ñ–∞–π–ª—ã:"
          ls -1 status_*.json 2>/dev/null | wc -l | xargs echo "   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:"
          
          echo ""
          echo "üìù –ò—Å—Ç–æ—Ä–∏—è:"
          if [ -f "post_history.json" ]; then
            echo "   ‚Ä¢ post_history.json"
          else
            echo "   ‚Ä¢ –§–∞–π–ª –∏—Å—Ç–æ—Ä–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi
          
          echo ""
          echo "‚è∞ Offset:"
          if [ -f "last_offset.txt" ]; then
            echo "   ‚Ä¢ last_offset.txt"
            cat last_offset.txt
          else
            echo "   ‚Ä¢ –§–∞–π–ª offset –Ω–µ –Ω–∞–π–¥–µ–Ω"
          fi
          
          echo "=" * 50
          
      - name: üíæ Commit changes
        if: always()
        run: |
          echo "üíæ –°–æ—Ö—Ä–∞–Ω—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --name-only | grep -q "\.json$" || git diff --name-only | grep -q "\.txt$"; then
            echo "üìù –ù–∞–π–¥–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            
            git config --global user.name 'GitHub Actions Bot'
            git config --global user.email 'actions@github.com'
            
            git add *.json *.txt
            git commit -m "Auto-update: processed callbacks [skip ci]" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
            
            # –ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—à–∏—Ç—å
            git pull --rebase origin main
            git push origin main || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—à–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
            
            echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"
          else
            echo "üì≠ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"
          fi
