name: Handle Telegram Callbacks

on:
  schedule:
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
    - cron: '* * * * *'
  workflow_dispatch:
    inputs:
      manual:
        description: 'Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº'
        required: false

jobs:
  process-callbacks:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ðŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: ðŸ“¦ Install dependencies
        run: pip install requests==2.31.0
        
      - name: ðŸ¤– Process Telegram Callbacks
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          echo "ðŸ”„ ÐÐ°Ñ‡Ð¸Ð½Ð°ÑŽ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ callback-Ð¾Ð²..."
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
          cat > process_callbacks.py << 'EOF'
          import os
          import requests
          import json
          import sys
          
          BOT_TOKEN = os.environ.get('BOT_TOKEN')
          
          if not BOT_TOKEN:
              print('âŒ BOT_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½')
              sys.exit(1)
          
          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¼Ð¾Ð´ÑƒÐ»ÑŒ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
          sys.path.append('.')
          try:
              from approval_bot import process_callback
              print('âœ… ÐœÐ¾Ð´ÑƒÐ»ÑŒ approval_bot Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½')
          except Exception as e:
              print(f'âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¼Ð¾Ð´ÑƒÐ»Ñ: {e}')
              sys.exit(1)
          
          # Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ offset
          try:
              with open('last_offset.txt', 'r') as f:
                  offset = int(f.read().strip())
              print(f'ðŸ“Š Offset Ð¸Ð· Ñ„Ð°Ð¹Ð»Ð°: {offset}')
          except:
              offset = 0
              print(f'ðŸ“Š ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ñ offset: 0')
          
          # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¾Ñ‚ Telegram
          try:
              response = requests.get(
                  f'https://api.telegram.org/bot{BOT_TOKEN}/getUpdates',
                  params={
                      'offset': offset,
                      'timeout': 10,
                      'allowed_updates': ['callback_query']
                  },
                  timeout=15
              )
              
              if response.status_code == 200:
                  data = response.json()
                  
                  if data.get('ok') and data.get('result'):
                      updates = data['result']
                      print(f'ðŸ“¨ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹: {len(updates)}')
                      
                      for update in updates:
                          new_offset = update['update_id'] + 1
                          
                          if 'callback_query' in update:
                              callback = update['callback_query']
                              callback_data = callback.get('data', '')
                              callback_id = callback.get('id', '')
                              
                              print(f'ðŸ”” ÐÐ°Ð¹Ð´ÐµÐ½ callback: {callback_data}')
                              print(f'   ID: {callback_id}')
                              
                              # ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ callback
                              success = process_callback(callback_data, callback_id)
                              
                              if success:
                                  print(f'âœ… Callback Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾')
                              else:
                                  print(f'âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ callback')
                              
                              # ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´Ð°ÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ callback
                              try:
                                  requests.post(
                                      f'https://api.telegram.org/bot{BOT_TOKEN}/answerCallbackQuery',
                                      params={'callback_query_id': callback_id},
                                      timeout=5
                                  )
                              except:
                                  pass
                          
                          offset = new_offset
                          print(f'ðŸ“ ÐÐ¾Ð²Ñ‹Ð¹ offset: {offset}')
                      
                      # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ offset
                      with open('last_offset.txt', 'w') as f:
                          f.write(str(offset))
                          
                      if not updates:
                          print('ðŸ“­ ÐÐ¾Ð²Ñ‹Ñ… callback-Ð¾Ð² Ð½ÐµÑ‚')
                      
                  else:
                      print('ðŸ“­ ÐÐµÑ‚ Ð½Ð¾Ð²Ñ‹Ñ… Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¹')
                      
              else:
                  print(f'âŒ ÐžÑˆÐ¸Ð±ÐºÐ° API: {response.status_code}')
                  
          except Exception as e:
              print(f'ðŸ’¥ ÐžÑˆÐ¸Ð±ÐºÐ°: {e}')
              import traceback
              traceback.print_exc()
          
          print('âœ… ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°')
          EOF
          
          # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÑƒ
          python process_callbacks.py
